<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Ultra Store 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #6366f1; --dark: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--text); margin: 0; }
        
        /* Navbar */
        nav { background: rgba(15,23,42,0.95); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--p); }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--p); }
        .cart-icon { position: relative; cursor: pointer; background: #334155; padding: 12px; border-radius: 50%; }

        /* Lock Section & Cancel */
        #lockSection { display: none; background: #1e293b; border: 2px solid #ef4444; margin: 20px 5%; padding: 25px; border-radius: 15px; text-align: center; animation: fadeIn 0.5s; }
        .cancel-btn { background: #ef4444; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        .cancel-btn:hover { background: #dc2626; transform: scale(1.05); }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 20px 5%; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid #334155; transition: 0.3s; position: relative; }
        .card:hover { border-color: var(--p); transform: translateY(-5px); }
        .card img { width: 100%; height: 320px; object-fit: cover; }
        .badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; }
        
        .info { padding: 20px; }
        .opt-btn { background: #0f172a; border: 1px solid #475569; color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        .opt-btn.active { background: var(--p); border-color: var(--p); }
        .buy-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--p); color: white; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .buy-btn:disabled { background: #475569; opacity: 0.5; cursor: not-allowed; }

        /* Checkout Page Overlay */
        #checkoutPage { position: fixed; inset: 0; background: var(--dark); z-index: 2000; display: none; padding: 5%; overflow-y: auto; }
        .checkout-box { max-width: 600px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid #334155; }
        .form-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 15px; box-sizing: border-box; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<nav>
    <div class="logo">NPX ULTRA</div>
    <div class="cart-icon" onclick="openCheckout()">
        <i class="fas fa-shopping-bag"></i>
        <span style="position:absolute; top:-5px; right:-5px; background:red; padding:2px 6px; border-radius:50%; font-size:0.7rem;" id="cCount">0</span>
    </div>
</nav>

<div id="lockSection">
    <i class="fas fa-clock fa-3x" style="color:#ef4444; margin-bottom:15px;"></i>
    <h3 style="margin:0;">Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
    <p style="color:#94a3b8;">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ù„Ø¨ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­ØªÙ‰ ÙŠØªÙ… ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¤Ù‡.</p>
    <button class="cancel-btn" onclick="cancelActiveOrder()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† â†©ï¸</button>
</div>

<div class="grid" id="productGrid"></div>

<div id="checkoutPage">
    <div class="checkout-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†</h2>
            <button onclick="closeCheckout()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div id="cartSummary"></div>
        <hr style="border:0.5px solid #334155; margin:20px 0;">
        
        <input type="text" id="uName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="tel" id="uPhone" class="form-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
        
        <button onclick="getLocation()" style="width:100%; padding:15px; background:#3b82f6; border:none; color:white; border-radius:12px; margin-bottom:15px; cursor:pointer; font-weight:bold;">
            <i class="fas fa-map-marker-alt"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (GPS)
        </button>
        
        <textarea id="uAddr" class="form-input" rows="3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„"></textarea>
        
        <button onclick="confirmOrder()" style="width:100%; padding:20px; background:#22c55e; border:none; color:white; font-size:1.2rem; font-weight:bold; border-radius:12px; cursor:pointer;">
            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† <i class="fab fa-whatsapp"></i>
        </button>
    </div>
</div>

<script>
    // ØªÙƒÙˆÙŠÙ† Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [], cart = [], isLocked = false, userLoc = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

    // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
    function checkStatus() {
        const orderKey = localStorage.getItem('activeOrderKey');
        if(orderKey) {
            isLocked = true;
            document.getElementById('lockSection').style.display = 'block';
        } else {
            isLocked = false;
            document.getElementById('lockSection').style.display = 'none';
        }
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
    db.ref('inventory').on('value', snap => {
        products = [];
        const data = snap.val();
        for(let id in data) products.push({ id, ...data[id] });
        checkStatus();
        render();
    });

    function render() {
        const container = document.getElementById('productGrid');
        container.innerHTML = products.map(p => `
            <div class="card">
                <div class="badge">Ù…ØªÙˆÙØ±: ${p.qty}</div>
                <img src="${p.img}">
                <div class="info">
                    <h3 style="margin:0 0 10px;">${p.name}</h3>
                    <b style="color:var(--p); font-size:1.4rem;">$${p.price}</b>
                    <div style="margin:15px 0 5px;">Ø§Ù„Ù…Ù‚Ø§Ø³:</div>
                    <div class="opt-group" id="size-${p.id}">
                        ${['S', 'M', 'L', 'XL'].map(s => `<button class="opt-btn" onclick="sel(this)">${s}</button>`).join('')}
                    </div>
                    <button class="buy-btn" ${isLocked || p.qty <= 0 ? 'disabled' : ''} onclick="addToCart('${p.id}')">
                        ${isLocked ? 'Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹Ø·Ù„' : (p.qty <= 0 ? 'Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' : 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© +')}
                    </button>
                </div>
            </div>
        `).join('');
    }

    function sel(btn) {
        btn.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        const sz = document.querySelector(`#size-${id} .active`);
        if(!sz) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³ Ø£ÙˆÙ„Ø§Ù‹!");
        
        cart.push({...p, selectedSize: sz.innerText});
        document.getElementById('cCount').innerText = cart.length;
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© âœ…");
    }

    function openCheckout() {
        if(isLocked || cart.length === 0) return;
        document.getElementById('checkoutPage').style.display = 'flex';
        let total = 0;
        document.getElementById('cartSummary').innerHTML = cart.map(i => {
            total += parseFloat(i.price);
            return `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${i.name} (${i.selectedSize})</span>
                <b>$${i.price}</b>
            </div>`;
        }).join('');
    }

    function closeCheckout() { document.getElementById('checkoutPage').style.display = 'none'; }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                userLoc = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
                document.getElementById('uAddr').value = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­";
            }, () => alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙŠØ¯ÙˆÙŠØ§Ù‹."));
        }
    }

    async function confirmOrder() {
        const n = document.getElementById('uName').value, ph = document.getElementById('uPhone').value, addr = document.getElementById('uAddr').value;
        if(!n || !ph) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ!");

        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù†Ù‚Øµ Ø§Ù„ÙƒÙ…ÙŠØ©)
        for(let item of cart) {
            const ref = db.ref(`inventory/${item.id}`);
            const snap = await ref.get();
            const currentQty = snap.val().qty;
            if(currentQty <= 1) await ref.remove(); else await ref.update({ qty: currentQty - 1 });
        }

        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
        const orderRef = db.ref('orders').push({
            user: n, phone: ph, items: cart.map(i => `${i.name} (${i.selectedSize})`),
            total: cart.reduce((s, i) => s + parseFloat(i.price), 0),
            location: userLoc, address: addr, timestamp: Date.now(),
            backup: cart // Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        });

        // 3. Ù‚ÙÙ„ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¥Ù„ØºØ§Ø¡
        localStorage.setItem('activeOrderKey', orderRef.key);
        localStorage.setItem('activeOrderData', JSON.stringify(cart));

        // 4. ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨
        const msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± NPX*\nâ”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${n}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${ph}\nğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${cart.map(i => i.name).join(', ')}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${userLoc}\nğŸ  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr}`;
        window.location.href = `https://wa.me/201221060599?text=${encodeURIComponent(msg)}`;
    }

    async function cancelActiveOrder() {
        const key = localStorage.getItem('activeOrderKey');
        const savedData = JSON.parse(localStorage.getItem('activeOrderData'));

        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ÙƒØŸ Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…Ø®Ø²ÙˆÙ†.")) {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
            for(let item of savedData) {
                const ref = db.ref(`inventory/${item.id}`);
                const snap = await ref.get();
                if(snap.exists()) {
                    await ref.update({ qty: snap.val().qty + 1 });
                } else {
                    await ref.set({ ...item, qty: 1 });
                }
            }
            // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Firebase ÙˆÙ…Ø³Ø­ Ø§Ù„Ù‚ÙÙ„
            await db.ref(`orders/${key}`).remove();
            localStorage.removeItem('activeOrderKey');
            localStorage.removeItem('activeOrderData');
            window.location.reload();
        }
    }
</script>
</body>
</html>
