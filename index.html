<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Elite Store | Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #6366f1; --dark: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--text); margin: 0; }
        
        /* Navbar */
        nav { background: rgba(15,23,42,0.95); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--p); }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--p); letter-spacing: 2px; }
        .cart-icon { position: relative; cursor: pointer; font-size: 1.4rem; background: #334155; padding: 10px; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; }
        .cart-count { position: absolute; top: -5px; right: -5px; background: #ef4444; font-size: 0.75rem; padding: 2px 6px; border-radius: 50%; }

        /* Filter Section */
        .header-content { padding: 30px 5%; text-align: center; background: linear-gradient(to bottom, #1e293b, #0f172a); }
        .filters { display: flex; gap: 10px; overflow-x: auto; padding: 20px 5%; scrollbar-width: none; justify-content: center; }
        .f-btn { background: #334155; border: none; color: white; padding: 10px 22px; border-radius: 25px; cursor: pointer; white-space: nowrap; transition: 0.3s; font-weight: 600; }
        .f-btn.active { background: var(--p); box-shadow: 0 0 15px var(--p); }
        .popular-btn { background: linear-gradient(45deg, #f59e0b, #ef4444); color: white; border: none; padding: 10px 22px; border-radius: 25px; cursor: pointer; font-weight: bold; }

        /* Product Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 20px 5% 50px; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid #334155; position: relative; transition: 0.4s; }
        .card:hover { transform: translateY(-10px); border-color: var(--p); }
        .card img { width: 100%; height: 320px; object-fit: cover; }
        .badge { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 5px 12px; border-radius: 10px; font-size: 0.8rem; }
        
        .config-area { padding: 20px; }
        .price-tag { font-size: 1.6rem; font-weight: bold; color: var(--p); margin-bottom: 15px; }
        .select-label { font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px; display: block; }
        .options { display: flex; gap: 8px; margin-bottom: 15px; }
        .opt-btn { background: #0f172a; border: 1px solid #475569; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .opt-btn.active { background: var(--p); border-color: var(--p); }
        .add-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--p); color: white; font-weight: bold; cursor: pointer; }

        /* Purchase Page Overlay */
        #checkoutPage { position: fixed; inset: 0; background: var(--dark); z-index: 2000; display: none; padding: 5% 5%; overflow-y: auto; }
        .checkout-grid { display: grid; grid-template-columns: 1fr 400px; gap: 40px; max-width: 1100px; margin: 0 auto; }
        @media (max-width: 900px) { .checkout-grid { grid-template-columns: 1fr; } }
        .item-card { display: flex; justify-content: space-between; background: #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 15px; border-right: 5px solid var(--p); }
        .form-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 15px; outline: none; }
        .confirm-btn { width: 100%; padding: 20px; border-radius: 15px; border: none; background: #22c55e; color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<nav>
    <div class="logo">NPX ELITE</div>
    <div class="cart-icon" onclick="openCheckout()">
        <i class="fas fa-shopping-bag"></i>
        <span class="cart-count" id="cCount">0</span>
    </div>
</nav>

<div class="header-content">
    <h1>Ø£ÙØ¶Ù„ ØªØ´ÙƒÙŠÙ„Ø© Ù…Ù„Ø§Ø¨Ø³ Ø£Ù†Ù…ÙŠ ÙˆÙƒØ§Ø¬ÙˆØ§Ù„</h1>
    <div class="filters">
        <button class="popular-btn" onclick="sortPopular()"><i class="fas fa-fire"></i> Ø§Ù„Ø£ÙƒØ«Ø± Ø±ÙˆØ§Ø¬Ø§Ù‹</button>
        <button class="f-btn active" onclick="setCat('Ø§Ù„ÙƒÙ„', this)">Ø§Ù„ÙƒÙ„</button>
        <button class="f-btn" onclick="setCat('ØªÙŠØ´ÙŠØ±Øª', this)">ØªÙŠØ´ÙŠØ±ØªØ§Øª</button>
        <button class="f-btn" onclick="setCat('Ù‡ÙˆØ¯ÙŠ', this)">Ù‡ÙˆØ¯ÙŠØ²</button>
    </div>
</div>

<div class="grid" id="productGrid"></div>

<div id="checkoutPage">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; max-width:1100px; margin-inline:auto;">
        <h1><i class="fas fa-cart-arrow-down"></i> Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h1>
        <button onclick="closeCheckout()" style="background:#ef4444; border:none; color:white; padding:12px 25px; border-radius:12px; cursor:pointer; font-weight:bold;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</button>
    </div>

    <div class="checkout-grid">
        <div id="cartItems"></div>
        <div style="background:#1e293b; padding:30px; border-radius:25px; height:fit-content; border: 1px solid #334155;">
            <h3 style="margin-top:0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h3>
            <input type="text" id="uName" class="form-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="tel" id="uPhone" class="input-field form-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
            <button onclick="getLoc()" style="width:100%; padding:12px; background:#3b82f6; border:none; color:white; border-radius:12px; margin-bottom:15px; cursor:pointer;">
                <i class="fas fa-location-dot"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
            </button>
            <textarea id="uAddr" class="form-input" rows="3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø§Ù„Ù…Ø¨Ù†Ù‰)"></textarea>
            
            <div style="font-size:1.6rem; margin:25px 0; display:flex; justify-content:space-between; border-top:1px solid #334155; padding-top:20px;">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨:</span>
                <span style="color:var(--p)">$<span id="totalVal">0.00</span></span>
            </div>
            <button class="confirm-btn" onclick="confirmOrder()">ØªØ£ÙƒÙŠØ¯ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ <i class="fab fa-whatsapp"></i></button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [], cart = [], currentCat = "Ø§Ù„ÙƒÙ„", userLoc = "";

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    db.ref('inventory').on('value', snap => {
        products = [];
        const data = snap.val();
        for(let id in data) products.push({ id, ...data[id] });
        render();
    });

    function render() {
        const container = document.getElementById('productGrid');
        const filtered = products.filter(p => currentCat === "Ø§Ù„ÙƒÙ„" || p.category === currentCat);
        
        container.innerHTML = filtered.map(p => `
            <div class="card">
                <div class="badge">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${p.qty}</div>
                <img src="${p.img}">
                <div class="config-area">
                    <h3 style="margin:0">${p.name}</h3>
                    <div class="price-tag">$${p.price}</div>
                    
                    <span class="select-label">Ø§Ù„Ù…Ù‚Ø§Ø³:</span>
                    <div class="options" id="size-${p.id}">
                        ${['S', 'M', 'L', 'XL'].map(s => `<button class="opt-btn" onclick="selectOpt(this)">${s}</button>`).join('')}
                    </div>

                    <span class="select-label">Ø§Ù„Ù„ÙˆÙ†:</span>
                    <div class="options" id="color-${p.id}">
                        ${['Ø£Ø³ÙˆØ¯', 'Ø£Ø¨ÙŠØ¶', 'Ø£Ø²Ø±Ù‚'].map(c => `<button class="opt-btn" onclick="selectOpt(this)">${c}</button>`).join('')}
                    </div>

                    <button class="add-btn" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© +</button>
                </div>
            </div>
        `).join('');
    }

    function selectOpt(btn) {
        btn.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        const sz = document.querySelector(`#size-${id} .active`);
        const cl = document.querySelector(`#color-${id} .active`);
        
        if(!sz || !cl) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù‚Ø§Ø³ ÙˆØ§Ù„Ù„ÙˆÙ†!");
        if(p.qty <= 0) return alert("Ù†ÙØ¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!");

        cart.push({ ...p, selectedSize: sz.innerText, selectedColor: cl.innerText, cartId: Date.now() });
        document.getElementById('cCount').innerText = cart.length;
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }

    function sortPopular() {
        products.sort((a, b) => (b.sales || 0) - (a.sales || 0));
        render();
    }

    function setCat(c, btn) {
        currentCat = c;
        document.querySelectorAll('.f-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function openCheckout() {
        if(cart.length === 0) return alert("Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©!");
        document.getElementById('checkoutPage').style.display = 'block';
        updateCheckoutUI();
    }

    function closeCheckout() { document.getElementById('checkoutPage').style.display = 'none'; }

    function updateCheckoutUI() {
        let total = 0;
        document.getElementById('cartItems').innerHTML = cart.map((item, idx) => {
            total += parseFloat(item.price);
            return `
                <div class="item-card">
                    <div>
                        <h3 style="margin:0">${item.name}</h3>
                        <p style="color:#94a3b8; margin:5px 0;">Ø§Ù„Ù…Ù‚Ø§Ø³: ${item.selectedSize} | Ø§Ù„Ù„ÙˆÙ†: ${item.selectedColor}</p>
                        <b style="color:var(--p)">$${item.price}</b>
                    </div>
                    <button onclick="cart.splice(${idx},1);updateCheckoutUI();" style="background:none; border:none; color:#ef4444; font-size:1.5rem; cursor:pointer;"><i class="fas fa-trash-alt"></i></button>
                </div>`;
        }).join('');
        document.getElementById('totalVal').innerText = total.toFixed(2);
        document.getElementById('cCount').innerText = cart.length;
    }

    function getLoc() {
        navigator.geolocation.getCurrentPosition(p => {
            userLoc = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`;
            document.getElementById('uAddr').value = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²)";
        });
    }

    async function confirmOrder() {
        const n = document.getElementById('uName').value, ph = document.getElementById('uPhone').value;
        if(!n || !ph) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ!");

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙˆØ§Ø¬
        for(let item of cart) {
            const ref = db.ref(`inventory/${item.id}`);
            const snap = await ref.get();
            const data = snap.val();
            if(data.qty <= 1) await ref.remove(); // Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ØµÙØ±Øª Ø§Ù„ÙƒÙ…ÙŠØ©
            else await ref.update({ qty: data.qty - 1, sales: (data.sales || 0) + 1 });
        }

        const msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± NPX*\n\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${n}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${ph}\nğŸ  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${document.getElementById('uAddr').value}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${userLoc}\n\nğŸ“¦ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:\n${cart.map(i => `- ${i.name} [Ø§Ù„Ù…Ù‚Ø§Ø³: ${i.selectedSize}, Ø§Ù„Ù„ÙˆÙ†: ${i.selectedColor}]`).join('\n')}\n\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: $${document.getElementById('totalVal').innerText}`;
        
        db.ref('orders').push({ user: n, phone: ph, items: cart.map(i => i.name), total: document.getElementById('totalVal').innerText, location: userLoc, status: 'processing' });
        
        window.location.href = `https://wa.me/201221060599?text=${encodeURIComponent(msg)}`;
    }
</script>
</body>
</html>
