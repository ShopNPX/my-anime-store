<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX STORE | ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ±ÿ≥ŸÖŸä</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Styles & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --p: #6366f1;
            --dark: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --red: #ef4444;
            --green: #10b981;
            --border: rgba(255,255,255,0.1);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--dark);
            color: var(--text);
            margin: 0;
            padding-bottom: 80px;
            user-select: none;
        }

        /* Navigation */
        nav {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 5%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .logo { font-weight: 900; color: var(--p); font-size: 1.5rem; letter-spacing: 1px; }

        .search-bar {
            flex: 1;
            margin: 0 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #1e293b;
            color: white;
            outline: none;
        }

        /* Order Status Bar */
        #status-bar {
            display: none;
            background: linear-gradient(90deg, #1e293b, #334155);
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid var(--p);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        /* Grid & Cards */
        .container { padding: 20px 5%; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--card);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: 0.3s;
        }

        .card:hover { transform: translateY(-5px); border-color: var(--p); }

        .card img { width: 100%; height: 280px; object-fit: cover; }

        .p-content { padding: 15px; }
        .p-title { font-size: 1.1rem; font-weight: 700; margin: 5px 0; }
        
        /* Size Buttons */
        .sizes { display: flex; gap: 8px; margin: 15px 0; }
        .sz-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #475569;
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .sz-btn.active { background: var(--p); border-color: var(--p); }
        .sz-btn:disabled { opacity: 0.2; cursor: not-allowed; text-decoration: line-through; }

        .price-tag { font-size: 1.3rem; color: var(--green); font-weight: 900; }

        .add-to-cart {
            width: 100%;
            padding: 12px;
            background: var(--p);
            border: none;
            color: white;
            font-weight: 800;
            border-radius: 12px;
            margin-top: 15px;
            cursor: pointer;
        }

        .add-to-cart:disabled { background: #475569; cursor: not-allowed; }

        /* Modal Styles */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 15px;
        }

        .modal-content {
            background: var(--card);
            padding: 25px;
            border-radius: 25px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0f172a;
            color: white;
        }

        .btn-confirm {
            background: var(--green);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 15px;
            width: 100%;
            font-weight: 900;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 15px;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--red);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<nav>
    <div class="logo">NPX STORE</div>
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨ŸÉ..." onkeyup="renderItems()">
    </div>
    <div onclick="openCart()" style="position:relative; cursor:pointer;">
        <i class="fas fa-shopping-cart fa-lg"></i>
        <span id="cartCount" class="cart-badge">0</span>
    </div>
</nav>

<!-- Live Status Section -->
<div id="status-bar">
    <div id="statusContent">
        <b style="color:var(--p)">üì¶ ÿ∑ŸÑÿ®ŸÉ ŸÇŸäÿØ ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©</b><br>
        <small id="statusTimer"></small><br>
        <button id="cancelBtn" onclick="cancelActiveOrder()" style="display:none; background:var(--red); color:white; border:none; padding:5px 15px; border-radius:8px; margin-top:10px; cursor:pointer; font-weight:bold;">ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®</button>
    </div>
</div>

<div class="container">
    <div class="grid" id="mainGrid"></div>
</div>

<!-- Cart Modal -->
<div id="cartModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0"><i class="fas fa-shopping-basket"></i> ÿ≠ŸÇŸäÿ®ÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ</h2>
        <div id="itemsList"></div>
        <div style="text-align:center; font-size:1.4rem; font-weight:900; margin:20px 0; color:var(--green);">
            ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: <span id="totalPrice">0</span> ÿ¨.ŸÖ
        </div>

        <input type="text" id="custName" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ´ŸÜÿßÿ¶Ÿä">
        <input type="tel" id="custPhone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ">
        <button onclick="getGPS()" style="width:100%; padding:10px; background:#3b82f6; color:white; border:none; border-radius:10px; cursor:pointer;"><i class="fas fa-location-dot"></i> ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ GPS</button>
        <textarea id="custAddr" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ (ÿßŸÑÿ¥ÿßÿ±ÿπÿå ÿßŸÑÿØŸàÿ±ÿå ÿπŸÑÿßŸÖÿ© ŸÖŸÖŸäÿ≤ÿ©)"></textarea>

        <button class="btn-confirm" onclick="checkout()"><i class="fab fa-whatsapp"></i> ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ® Ÿàÿ•ÿ±ÿ≥ÿßŸÑ</button>
        <button onclick="closeCart()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; cursor:pointer;">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>
</div>

<script>
    // Firebase Setup
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [], cart = [], gpsLink = "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ";

    // 1. Listen to Products (Live Inventory)
    db.ref('inventory').on('value', snap => {
        products = [];
        snap.forEach(c => products.push({id: c.key, ...c.val()}));
        renderItems();
    });

    // 2. Render Products to UI
    function renderItems() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const grid = document.getElementById('mainGrid');
        const activeOrder = localStorage.getItem('order_id');

        grid.innerHTML = products.filter(p => p.name.toLowerCase().includes(q)).map(p => `
            <div class="card">
                <img src="${p.img}">
                <div class="p-content">
                    <div class="p-title">${p.name}</div>
                    <div class="sizes" id="sizes-${p.id}">
                        <button class="sz-btn" ${p.s<=0?'disabled':''} onclick="selectSize(this,'s')">S</button>
                        <button class="sz-btn" ${p.m<=0?'disabled':''} onclick="selectSize(this,'m')">M</button>
                        <button class="sz-btn" ${p.l<=0?'disabled':''} onclick="selectSize(this,'l')">L</button>
                        <button class="sz-btn" ${p.xl<=0?'disabled':''} onclick="selectSize(this,'xl')">XL</button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="price-tag">${p.price} ÿ¨.ŸÖ</span>
                        <button class="add-to-cart" style="width:auto; padding:8px 15px;" 
                            ${activeOrder ? 'disabled' : ''} onclick="addToCart('${p.id}')">
                            ${activeOrder ? 'ŸÑÿØŸäŸÉ ÿ∑ŸÑÿ®' : 'ÿ•ÿ∂ÿßŸÅÿ© +'}
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function selectSize(btn, s) {
        btn.parentElement.querySelectorAll('.sz-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        btn.dataset.selected = s;
    }

    // 3. Stock Validation Logic
    function addToCart(id) {
        const product = products.find(p => p.id === id);
        const sizeBtn = document.querySelector(`#sizes-${id} .active`);
        
        if(!sizeBtn) return alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÇÿßÿ≥ ÿ£ŸàŸÑÿßŸã");
        
        const size = sizeBtn.dataset.selected;
        const stockLimit = parseInt(product[size]);
        const itemInCart = cart.find(i => i.id === id && i.sz === size);
        
        // Validation: Check if user exceeded stock
        if(itemInCart) {
            if(itemInCart.qty + 1 > stockLimit) {
                return alert(`ÿπÿ∞ÿ±ÿßŸãÿå Ÿáÿ∞ÿß ŸáŸà ÿ£ŸÇÿµŸâ ÿ≠ÿØ ŸÖÿ™ÿßÿ≠ ŸÅŸä ÿßŸÑŸÖÿÆÿ≤ŸÜ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸÇÿßÿ≥ (${stockLimit})`);
            }
            itemInCart.qty++;
        } else {
            cart.push({ id, name: product.name, price: product.price, sz: size, qty: 1 });
        }
        
        updateCartCount();
        alert("ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ© ‚úÖ");
    }

    function updateCartCount() {
        const count = cart.reduce((acc, item) => acc + item.qty, 0);
        document.getElementById('cartCount').innerText = count;
    }

    function openCart() {
        document.getElementById('cartModal').style.display = 'flex';
        renderCartItems();
    }

    function closeCart() { document.getElementById('cartModal').style.display = 'none'; }

    function renderCartItems() {
        const area = document.getElementById('itemsList');
        let total = 0;
        area.innerHTML = cart.map((item, idx) => {
            total += (item.price * item.qty);
            return `
                <div class="cart-item">
                    <div>
                        <b>${item.name}</b> <small>(${item.sz.toUpperCase()})</small><br>
                        <span>${item.qty} √ó ${item.price} ÿ¨.ŸÖ</span>
                    </div>
                    <i class="fas fa-trash" style="color:var(--red); cursor:pointer;" onclick="removeItem(${idx})"></i>
                </div>
            `;
        }).join('');
        document.getElementById('totalPrice').innerText = total;
    }

    function removeItem(idx) {
        cart.splice(idx, 1);
        updateCartCount();
        renderCartItems();
    }

    function getGPS() {
        navigator.geolocation.getCurrentPosition(pos => {
            gpsLink = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
            document.getElementById('custAddr').value = "‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠";
        }, err => alert("Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÄ GPS ŸÑÿ™ŸàÿµŸäŸÑ ÿ£ÿ≥ÿ±ÿπ"));
    }

    // 4. Checkout & WhatsApp Formatting
    async function checkout() {
        const name = document.getElementById('custName').value;
        const phone = document.getElementById('custPhone').value;
        const addr = document.getElementById('custAddr').value;
        const total = document.getElementById('totalPrice').innerText;

        if(!name || !phone || !addr || cart.length === 0) return alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™");

        // Format WhatsApp Message
        let itemsText = cart.map(i => `‚Ä¢ ${i.name} (${i.sz.toUpperCase()}) x${i.qty}`).join('%0A');
        let waMsg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ ŸÖŸÜ NPX STORE*%0A` +
                    `--------------------------%0A` +
                    `*ÿßŸÑÿßÿ≥ŸÖ:* ${name}%0A` +
                    `*ÿßŸÑŸáÿßÿ™ŸÅ:* ${phone}%0A` +
                    `*ÿßŸÑÿπŸÜŸàÿßŸÜ:* ${addr}%0A` +
                    `--------------------------%0A` +
                    `*ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™:*%0A${itemsText}%0A` +
                    `--------------------------%0A` +
                    `*ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:* ${total} ÿ¨.ŸÖ%0A` +
                    `*ÿßŸÑŸÖŸàŸÇÿπ:* ${gpsLink}`;

        // Update Stock in DB
        for(let item of cart) {
            const ref = db.ref(`inventory/${item.id}/${item.sz}`);
            const currentStock = await ref.get();
            await ref.set(currentStock.val() - item.qty);
        }

        // Push Order to Admin
        const orderRef = db.ref('orders').push({
            name, phone, addr, total, gps: gpsLink, 
            items: cart, ts: Date.now()
        });

        // Store Order locally to watch status
        localStorage.setItem('order_id', orderRef.key);
        localStorage.setItem('order_items', JSON.stringify(cart));

        // Redirect to WA
        window.location.href = `https://wa.me/201221060599?text=${waMsg}`;
    }

    // 5. Active Order Tracking (Auto-Delete Listener)
    const activeOrderID = localStorage.getItem('order_id');
    if(activeOrderID) {
        db.ref('orders/' + activeOrderID).on('value', snap => {
            const bar = document.getElementById('status-bar');
            
            // If the order node is gone (Admin finished or canceled it)
            if(!snap.exists()) {
                if(localStorage.getItem('order_id')) {
                    localStorage.clear();
                    alert("ÿ™ŸÖÿ™ ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠! ÿ¥ŸÉÿ±ÿßŸã ŸÑŸÉ.");
                    location.reload();
                }
                return;
            }

            // If order exists, show the bar
            const orderData = snap.val();
            bar.style.display = 'block';
            
            const minutesPassed = (Date.now() - orderData.ts) / 1000 / 60;
            if(minutesPassed < 60) {
                document.getElementById('cancelBtn').style.display = 'inline-block';
                document.getElementById('statusTimer').innerText = `ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ° ÿÆŸÑÿßŸÑ ${Math.floor(60 - minutesPassed)} ÿØŸÇŸäŸÇÿ©`;
            } else {
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('statusTimer').innerText = "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿ∑ŸÑÿ®ŸÉ ÿßŸÑÿ¢ŸÜ";
            }
        });
    }

    async function cancelActiveOrder() {
        if(!confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ∑ŸÑÿ®ÿü ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑŸÖÿÆÿ≤ŸÜ.")) return;
        
        const id = localStorage.getItem('order_id');
        const items = JSON.parse(localStorage.getItem('order_items'));

        // Restore Stock
        for(let i of items) {
            const ref = db.ref(`inventory/${i.id}/${i.sz}`);
            const current = await ref.get();
            await ref.set(current.val() + i.qty);
        }

        // Remove Order
        db.ref('orders/' + id).remove();
        localStorage.clear();
        location.reload();
    }
</script>

</body>
</html>
