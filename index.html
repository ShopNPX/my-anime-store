<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX STORE | النسخة النهائية الشاملة</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #6366f1; --bg: #030712; --card: #111827; --text: #ffffff; --border: rgba(255,255,255,0.1); --success: #10b981; }
        [data-theme="light"] { --bg: #f3f4f6; --card: #ffffff; --text: #111827; --border: rgba(0,0,0,0.1); }
        * { box-sizing: border-box; transition: 0.3s ease; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding-top: 215px; overflow-x: hidden; }

        /* Header */
        header { position: fixed; top: 0; width: 100%; background: var(--bg); z-index: 1000; border-bottom: 1px solid var(--border); }
        .nav-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; }
        .icon-btn { width: 45px; height: 45px; border-radius: 12px; background: var(--card); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); position: relative; color: var(--text); }
        #cartCount { position: absolute; top: -5px; right: -5px; background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; }

        /* Search & Cats */
        .search-area { padding: 0 5% 10px; }
        .search-bar { background: var(--card); border-radius: 12px; display: flex; align-items: center; padding: 5px 15px; border: 1px solid var(--border); }
        .search-bar input { background: transparent; border: none; color: var(--text); padding: 10px; width: 100%; outline: none; }
        .categories { display: flex; gap: 10px; padding: 12px 5%; overflow-x: auto; background: var(--bg); border-top: 1px solid var(--border); }
        .cat-btn { padding: 8px 18px; border-radius: 50px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; white-space: nowrap; font-size: 0.85rem; }
        .cat-btn.active { background: var(--primary); color: white; }

        /* Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 20px 5%; }
        .product-card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); position: relative; text-align: center; padding-bottom: 15px; }
        .product-card img { width: 100%; height: 280px; object-fit: cover; }
        
        /* Sidebars */
        .sidebar { position: fixed; top: 0; left: -100%; width: 100%; max-width: 450px; height: 100%; background: var(--card); z-index: 2001; display: flex; flex-direction: column; box-shadow: 20px 0 50px #000; visibility: hidden; }
        .sidebar.open { left: 0; visibility: visible; }
        .sb-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .sb-body { padding: 20px; flex: 1; overflow-y: auto; }

        /* Components */
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; }
        .admin-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-right: 4px solid var(--primary); }

        @media (max-width: 500px) { body { padding-top: 195px; } .product-grid { grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; } .product-card img { height: 200px; } }
    </style>
</head>
<body data-theme="dark">

    <header>
        <div class="nav-top">
            <div style="font-weight: 900; font-size: 1.6rem;">NPX<span style="color:var(--primary)">STORE</span></div>
            <div class="nav-icons">
                <div class="icon-btn" onclick="toggleSidebar('adminPanel', true)"><i class="fas fa-user-shield"></i></div>
                <div class="icon-btn" onclick="toggleSidebar('trackSide', true)"><i class="fas fa-truck"></i></div>
                <div class="icon-btn" onclick="toggleSidebar('cartSide', true)">
                    <i class="fas fa-shopping-basket"></i>
                    <span id="cartCount">0</span>
                </div>
            </div>
        </div>
        <div class="search-area">
            <div class="search-bar"><i class="fas fa-search"></i><input type="text" id="srch" placeholder="بحث عن موديل..." onkeyup="render()"></div>
        </div>
        <div class="categories" id="catBar">
            <button class="cat-btn active" onclick="filterBy('الكل', this)">الكل</button>
            <button class="cat-btn" onclick="filterBy('تيشيرتات', this)">تيشيرتات</button>
            <button class="cat-btn" onclick="filterBy('هوديز', this)">هوديز</button>
        </div>
    </header>

    <div class="product-grid" id="grid"></div>

    <div class="sidebar" id="cartSide">
        <div class="sb-header"><h3>حقيبة التسوق</h3><i class="fas fa-times" onclick="toggleSidebar('cartSide', false)"></i></div>
        <div class="sb-body" id="cartItems"></div>
        <div style="padding: 20px; border-top: 1px solid var(--border);">
            <div style="display:flex; gap:5px; margin-bottom:10px">
                <input id="promo" placeholder="كود الخصم" class="input-field" style="margin:0">
                <button onclick="applyPromo()" style="background:var(--success); color:white; border:none; border-radius:10px; padding:0 15px">تطبيق</button>
            </div>
            <h3 id="finalPrice">الإجمالي: 0 ج.م</h3>
            <button class="btn-main" onclick="toggleSidebar('orderSide', true)">اتمام الشراء</button>
        </div>
    </div>

    <div class="sidebar" id="trackSide">
        <div class="sb-header"><h3>تتبع طلبك</h3><i class="fas fa-times" onclick="toggleSidebar('trackSide', false)"></i></div>
        <div class="sb-body">
            <input type="tel" id="trackPhone" placeholder="رقم الهاتف المستخدم..." class="input-field">
            <button class="btn-main" onclick="trackOrder()">بحث عن الحالة</button>
            <div id="trackResult" style="margin-top:20px"></div>
        </div>
    </div>

    <div class="sidebar" id="orderSide">
        <div class="sb-header"><h3>بيانات الشحن</h3><i class="fas fa-times" onclick="toggleSidebar('orderSide', false)"></i></div>
        <div class="sb-body">
            <button class="btn-main" style="background:var(--success)" onclick="autoGPS()">
                <i class="fas fa-map-marker-alt"></i> تحديد موقعي GPS تلقائياً
            </button>
            <input id="uName" placeholder="الاسم الثنائي" class="input-field">
            <input id="uPhone" placeholder="رقم الموبايل" class="input-field">
            <input id="uAddr" placeholder="العنوان (أو سيظهر الـ GPS هنا)" class="input-field">
            <p style="font-size:0.8rem; color:orange">الدفع عند الاستلام</p>
            <button class="btn-main" onclick="confirmOrder()">تأكيد الطلب وفتح واتساب</button>
        </div>
    </div>

    <div class="sidebar" id="adminPanel">
        <div class="sb-header"><h3>لوحة التحكم</h3><i class="fas fa-times" onclick="toggleSidebar('adminPanel', false)"></i></div>
        <div class="sb-body">
            <div id="adminLogin">
                <input type="password" id="adminPw" placeholder="كلمة المرور" class="input-field">
                <button class="btn-main" onclick="adminAuth()">دخول المسؤول</button>
            </div>
            <div id="adminContent" style="display:none">
                <button class="btn-main" onclick="toggleTheme()">تغيير ثيم المتجر</button>
                <hr>
                <h4>إضافة منتج</h4>
                <input id="pN" placeholder="الاسم" class="input-field">
                <input id="pI" placeholder="رابط الصورة" class="input-field">
                <input id="pP" placeholder="السعر" class="input-field" type="number">
                <select id="pC" class="input-field"><option>تيشيرتات</option><option>هوديز</option></select>
                <button class="btn-main" onclick="saveP()">إضافة للمتجر</button>
                <hr>
                <h4>الطلبات الجديدة</h4>
                <div id="adminOrders"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase Config
        const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let prods = [], cart = [], currentCat = "الكل", discount = 0;

        // 2. Fetch Data
        db.ref('inventory').on('value', s => {
            prods = []; s.forEach(x => prods.push({id: x.key, ...x.val()})); render();
        });

        function render() {
            const q = document.getElementById('srch').value.toLowerCase();
            const g = document.getElementById('grid'); g.innerHTML = '';
            prods.filter(p => (currentCat === "الكل" || p.category === currentCat) && p.name.toLowerCase().includes(q))
            .forEach(p => {
                g.innerHTML += `
                <div class="product-card">
                    <img src="${p.img}">
                    <h4>${p.name}</h4>
                    <div style="color:var(--primary); font-weight:900">${p.price} ج.م</div>
                    <button class="btn-main" style="width:80%; margin:10px auto;" onclick="addToCart('${p.id}')">أضف للسلة</button>
                </div>`;
            });
        }

        // 3. Cart & Logic
        function addToCart(id) {
            const p = prods.find(x => x.id === id);
            const item = cart.find(i => i.id === id);
            item ? item.qty++ : cart.push({...p, qty: 1});
            updateCart(); toggleSidebar('cartSide', true);
        }

        function updateCart() {
            let total = 0; const list = document.getElementById('cartItems'); list.innerHTML = '';
            cart.forEach((i, idx) => {
                total += (i.price * i.qty);
                list.innerHTML += `
                <div style="display:flex; gap:10px; margin-bottom:15px; background:rgba(0,0,0,0.05); padding:10px; border-radius:12px;">
                    <img src="${i.img}" style="width:50px; height:50px; border-radius:8px;">
                    <div style="flex:1"><b>${i.name}</b><br>${i.price} ج.م</div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button onclick="changeQty(${idx},-1)">-</button>
                        <b>${i.qty}</b>
                        <button onclick="changeQty(${idx},1)">+</button>
                    </div>
                </div>`;
            });
            document.getElementById('cartCount').innerText = cart.length;
            document.getElementById('finalPrice').innerText = `الإجمالي: ${total - discount} ج.م`;
        }

        function changeQty(idx, val) {
            cart[idx].qty += val;
            if(cart[idx].qty < 1) cart.splice(idx, 1);
            updateCart();
        }

        // 4. GPS & Order
        function autoGPS() {
            const field = document.getElementById('uAddr'); field.value = "جاري تحديد موقعك...";
            navigator.geolocation.getCurrentPosition(pos => {
                field.value = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
            }, () => { field.value = "فشل التحديد؛ يرجى الكتابة يدوياً"; });
        }

        async function confirmOrder() {
            const n = document.getElementById('uName').value, ph = document.getElementById('uPhone').value, ad = document.getElementById('uAddr').value;
            if(!n || !ph || !ad || cart.length === 0) return alert("أكمل البيانات والسلة");
            
            const orderData = { name:n, phone:ph, addr:ad, items:cart, total:document.getElementById('finalPrice').innerText, status:'قيد المراجعة', date:new Date().toLocaleString('ar-EG') };
            await db.ref('orders').push(orderData);
            
            // WhatsApp Message
            const msg = `*طلب جديد NPX STORE*%0A*الاسم:* ${n}%0A*العنوان:* ${ad}%0A*الطلبات:*%0A${cart.map(i=>`• ${i.name} x${i.qty}`).join('%0A')}%0A*الحساب:* ${orderData.total}`;
            window.open(`https://wa.me/201221060599?text=${encodeURIComponent(msg)}`);
            location.reload();
        }

        // 5. Admin & Tracking
        function adminAuth() { if(document.getElementById('adminPw').value === "123") { document.getElementById('adminLogin').style.display='none'; document.getElementById('adminContent').style.display='block'; syncAdmin(); } }
        
        function syncAdmin() {
            db.ref('orders').on('value', s => {
                const area = document.getElementById('adminOrders'); area.innerHTML = '';
                s.forEach(x => {
                    const o = x.val();
                    area.innerHTML += `
                    <div class="admin-item">
                        <b>${o.name}</b> (${o.phone})<br>
                        <select onchange="db.ref('orders/${x.key}/status').set(this.value)">
                            <option>${o.status}</option>
                            <option value="تم الشحن">تم الشحن</option>
                            <option value="تم التوصيل">تم التوصيل</option>
                        </select>
                        <button onclick="window.open('${o.addr}')">خريطة</button>
                        <button onclick="db.ref('orders/${x.key}').remove()" style="color:red">حذف</button>
                    </div>`;
                });
            });
        }

        function trackOrder() {
            const ph = document.getElementById('trackPhone').value;
            db.ref('orders').orderByChild('phone').equalTo(ph).on('value', s => {
                const res = document.getElementById('trackResult'); res.innerHTML = '';
                s.forEach(o => { res.innerHTML += `<div class="admin-item">طلب بتاريخ ${o.val().date}<br>الحالة: <b>${o.val().status}</b></div>`; });
            });
        }

        function saveP() {
            db.ref('inventory').push({ name:document.getElementById('pN').value, img:document.getElementById('pI').value, price:document.getElementById('pP').value, category:document.getElementById('pC').value });
            alert("تم النشر");
        }

        function applyPromo() { if(document.getElementById('promo').value === "NPX10") { discount = 50; alert("تم خصم 50 ج.م"); updateCart(); } }
        function toggleSidebar(id, s) { document.getElementById(id).classList.toggle('open', s); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='dark'?'light':'dark'); }
        function filterBy(c, b) { document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); currentCat=c; render(); }
    </script>
</body>
</html>
