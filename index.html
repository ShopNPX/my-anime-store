<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX STORE | النسخة الاحترافية الشاملة</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --bg: #030712;
            --card: #111827;
            --text: #ffffff;
            --border: rgba(255,255,255,0.1);
            --danger: #ef4444;
            --success: #10b981;
        }

        [data-theme="light"] {
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #111827;
            --border: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; transition: 0.3s ease; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding-top: 210px; overflow-x: hidden; }

        /* Header */
        header { position: fixed; top: 0; width: 100%; background: var(--bg); z-index: 1000; border-bottom: 1px solid var(--border); }
        .nav-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; }
        .nav-icons { display: flex; gap: 10px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 12px; background: var(--card); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); position: relative; color: var(--text); }
        #cartCount { position: absolute; top: -5px; right: -5px; background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; }

        /* Search & Categories */
        .search-area { padding: 0 5% 10px; }
        .search-bar { background: var(--card); border-radius: 12px; display: flex; align-items: center; padding: 5px 15px; border: 1px solid var(--border); }
        .search-bar input { background: transparent; border: none; color: var(--text); padding: 10px; width: 100%; outline: none; font-size: 1rem; }
        
        .categories { display: flex; gap: 10px; padding: 12px 5%; overflow-x: auto; background: var(--bg); border-top: 1px solid var(--border); }
        .categories::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 8px 18px; border-radius: 50px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; white-space: nowrap; font-size: 0.85rem; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Products Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; padding: 20px 5%; }
        .product-card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); position: relative; }
        .product-card img { width: 100%; height: 320px; object-fit: cover; }
        .p-badge { position: absolute; top: 10px; left: 10px; background: var(--primary); color: white; padding: 3px 10px; border-radius: 8px; font-size: 0.7rem; }

        /* Sidebars */
        .sidebar { position: fixed; top: 0; left: -100%; width: 100%; max-width: 450px; height: 100%; background: var(--card); z-index: 2001; display: flex; flex-direction: column; box-shadow: 20px 0 50px rgba(0,0,0,0.5); visibility: hidden; }
        .sidebar.open { left: 0; visibility: visible; }
        .sb-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        
        /* Buttons & Inputs */
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; }

        .admin-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 4px solid var(--primary); }

        @media (max-width: 500px) { 
            .product-grid { grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; } 
            body { padding-top: 195px; } 
            .product-card img { height: 220px; }
        }
    </style>
</head>
<body data-theme="dark">

    <header>
        <div class="nav-top">
            <div style="font-weight: 900; font-size: 1.6rem;">NPX<span style="color:var(--primary)">STORE</span></div>
            <div class="nav-icons">
                <div class="icon-btn" onclick="toggleSidebar('adminPanel', true)"><i class="fas fa-user-shield"></i></div>
                <div class="icon-btn" onclick="toggleSidebar('settingsSidebar', true)"><i class="fas fa-cog"></i></div>
                <div class="icon-btn" onclick="toggleSidebar('cartSidebar', true)">
                    <i class="fas fa-shopping-basket"></i>
                    <span id="cartCount">0</span>
                </div>
            </div>
        </div>
        <div class="search-area">
            <div class="search-bar">
                <i class="fas fa-search" style="opacity: 0.4;"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن موديلات NPX..." onkeyup="render()">
            </div>
        </div>
        <div class="categories" id="catBar">
            <button class="cat-btn active" onclick="filterBy('الكل', this)">الكل</button>
            <button class="cat-btn" onclick="filterBy('تيشيرتات', this)">تيشيرتات</button>
            <button class="cat-btn" onclick="filterBy('هوديز', this)">هوديز</button>
            <button class="cat-btn" onclick="filterBy('بنطلونات', this)">بنطلونات</button>
        </div>
    </header>

    <div class="product-grid" id="productGrid"></div>

    <div class="sidebar" id="settingsSidebar">
        <div class="sb-header"><h3>الإعدادات والمتابعة</h3><div onclick="toggleSidebar('settingsSidebar', false)">X</div></div>
        <div style="padding: 20px;">
            <button class="btn-main" onclick="toggleTheme()">تغيير وضع الإضاءة</button>
            <hr style="opacity:0.1; margin: 20px 0;">
            <h4>تتبع حالة طلبك</h4>
            <input type="tel" id="trackPhone" placeholder="رقم الهاتف المسجل..." class="input-field">
            <button class="btn-main" onclick="trackOrder()">تحديث الحالة</button>
            <div id="trackerResults" style="margin-top:15px;"></div>
        </div>
    </div>

    <div class="sidebar" id="adminPanel">
        <div class="sb-header"><h3>لوحة التحكم</h3><div onclick="toggleSidebar('adminPanel', false)">X</div></div>
        <div style="padding: 20px; overflow-y: auto;">
            <div id="adminLogin">
                <input type="password" id="adminPass" placeholder="كلمة المرور" class="input-field">
                <button class="btn-main" onclick="checkAdmin()">دخول</button>
            </div>
            <div id="adminContent" style="display:none;">
                <h4>إضافة منتج جديد</h4>
                <input id="pName" placeholder="اسم المنتج" class="input-field">
                <input id="pImg" placeholder="رابط الصورة" class="input-field">
                <input id="pPrice" placeholder="السعر" class="input-field" type="number">
                <select id="pCat" class="input-field"><option>تيشيرتات</option><option>هوديز</option><option>بنطلونات</option></select>
                <button class="btn-main" onclick="addProduct()">حفظ المنتج</button>
                <hr style="margin:20px 0;">
                <h4>الطلبات الجديدة</h4>
                <div id="adminOrdersList"></div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="cartSidebar">
        <div class="sb-header"><h3>سلة التسوق</h3><div onclick="toggleSidebar('cartSidebar', false)">X</div></div>
        <div id="cartList" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding:20px; border-top:1px solid var(--border);">
            <h3 id="totalLabel">الإجمالي: 0 ج.م</h3>
            <button class="btn-main" onclick="toggleSidebar('orderModal', true)">تأكيد البيانات</button>
        </div>
    </div>

    <div class="sidebar" id="orderModal">
        <div class="sb-header"><h3>بيانات الشحن</h3><div onclick="toggleSidebar('orderModal', false)">X</div></div>
        <div style="padding: 20px;">
            <button class="btn-main" style="background:none; border:1px solid var(--primary); color:var(--text)" onclick="manualLocate()">تحديد موقعي GPS</button>
            <input type="text" id="uName" placeholder="الاسم الكامل" class="input-field">
            <input type="tel" id="uPhone" placeholder="رقم الموبايل" class="input-field">
            <input type="text" id="uAddr" placeholder="العنوان بالتفصيل" class="input-field">
            <button class="btn-main" onclick="processFinalOrder()">إرسال الطلب عبر واتساب</button>
        </div>
    </div>

    <script>
        // 1. CONFIG
        const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allProducts = [], cart = [], currentCat = "الكل", userLocation = null;

        // 2. FETCH DATA
        db.ref('inventory').on('value', snap => {
            allProducts = [];
            snap.forEach(c => allProducts.push({id: c.key, ...c.val()}));
            render();
        });

        function render() {
            const grid = document.getElementById('productGrid');
            const query = document.getElementById('searchInput').value.toLowerCase();
            grid.innerHTML = '';
            allProducts.filter(p => (currentCat === "الكل" || p.category === currentCat) && p.name.toLowerCase().includes(query))
            .forEach(p => {
                grid.innerHTML += `
                <div class="product-card">
                    <img src="${p.img}">
                    <div style="padding:15px; text-align:center;">
                        <h4>${p.name}</h4>
                        <div style="color:var(--primary); font-weight:bold;">${p.price} ج.م</div>
                        <select id="sz-${p.id}" class="input-field" style="margin-top:10px;"><option value="M">M</option><option value="L">L</option><option value="XL">XL</option></select>
                        <button class="btn-main" onclick="addToCart('${p.id}')">إضافة للسلة</button>
                    </div>
                </div>`;
            });
        }

        // 3. CART SYSTEM
        function addToCart(id) {
            const p = allProducts.find(x => x.id === id);
            const size = document.getElementById(`sz-${id}`).value;
            const item = cart.find(i => i.id === id && i.selectedSize === size);
            item ? item.qty++ : cart.push({...p, selectedSize: size, qty: 1});
            updateUI(); toggleSidebar('cartSidebar', true);
        }

        function updateUI() {
            const list = document.getElementById('cartList');
            let subtotal = 0; list.innerHTML = '';
            cart.forEach((item, idx) => {
                subtotal += (item.price * item.qty);
                list.innerHTML += `<div style="margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:5px;">${item.name} (${item.selectedSize}) x${item.qty} - ${item.price}ج.م <i class="fas fa-trash" style="color:red; cursor:pointer; float:left" onclick="cart.splice(${idx},1);updateUI()"></i></div>`;
            });
            document.getElementById('cartCount').innerText = cart.length;
            document.getElementById('totalLabel').innerText = `الإجمالي: ${subtotal} ج.م`;
        }

        // 4. ORDER SYSTEM
        async function processFinalOrder() {
            const n = document.getElementById('uName').value, ph = document.getElementById('uPhone').value, ad = document.getElementById('uAddr').value;
            if(!n || !ph || !ad) return alert("أكمل البيانات");
            
            const maps = userLocation ? `https://www.google.com/maps?q=${userLocation}` : ad;
            const orderData = { name:n, phone:ph, addr:ad, items:cart, total:document.getElementById('totalLabel').innerText, gps:maps, date:new Date().toLocaleString('ar-EG'), status:'قيد المراجعة' };

            await db.ref('orders').push(orderData);
            
            const wpMsg = `*طلب جديد من NPX STORE*%0A*الاسم:* ${n}%0A*الطلبات:*%0A${cart.map(i=>`• ${i.name} (${i.selectedSize}) x${i.qty}`).join('%0A')}%0A*الحساب:* ${orderData.total}%0A*الموقع:* ${maps}`;
            window.open(`https://wa.me/201221060599?text=${wpMsg}`, '_blank');
            location.reload();
        }

        // 5. ADMIN & TRACKING
        function checkAdmin() { if(document.getElementById('adminPass').value === "123") { document.getElementById('adminLogin').style.display='none'; document.getElementById('adminContent').style.display='block'; loadAdminOrders(); } }
        
        function loadAdminOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('adminOrdersList'); list.innerHTML = '';
                snap.forEach(c => {
                    const o = c.val();
                    list.innerHTML += `<div class="admin-card"><b>${o.name}</b> (${o.phone})<br>حالة: ${o.status}<br>
                    <button onclick="db.ref('orders/${c.key}/status').set('تم الشحن')">تم الشحن</button>
                    <button onclick="db.ref('orders/${c.key}/status').set('تم التوصيل')">تم التوصيل</button>
                    <button onclick="window.open('${o.gps}')">GPS</button></div>`;
                });
            });
        }

        function trackOrder() {
            const ph = document.getElementById('trackPhone').value;
            db.ref('orders').orderByChild('phone').equalTo(ph).on('value', snap => {
                let res = document.getElementById('trackerResults'); res.innerHTML = '';
                snap.forEach(c => { res.innerHTML += `<div class="admin-card">طلب بتاريخ ${c.val().date} <br> الحالة: <b>${c.val().status}</b></div>`; });
            });
        }

        function addProduct() {
            db.ref('inventory').push({
                name: document.getElementById('pName').value,
                img: document.getElementById('pImg').value,
                price: document.getElementById('pPrice').value,
                category: document.getElementById('pCat').value
            });
            alert("تم الحفظ");
        }

        function manualLocate() { navigator.geolocation.getCurrentPosition(p => userLocation = `${p.coords.latitude},${p.coords.longitude}`); alert("تم تحديد الموقع"); }
        function toggleSidebar(id, s) { document.getElementById(id).classList.toggle('open', s); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='dark'?'light':'dark'); }
        function filterBy(c, b) { document.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); currentCat=c; render(); }
    </script>
</body>
</html>
