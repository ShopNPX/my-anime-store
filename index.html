<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Store | Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --main: #0f172a; --accent: #6366f1; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--main); color: var(--text); margin: 0; }
        header { background: #000; padding: 20px 5%; position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--accent); }
        .search-bar { width: 100%; padding: 12px; border-radius: 25px; border: none; background: #334155; color: white; margin-top: 10px; }
        .container { display: flex; flex-wrap: wrap; padding: 20px 5%; gap: 20px; }
        .products-grid { flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #334155; position: relative; }
        .qty-badge { position: absolute; top: 10px; left: 10px; background: var(--accent); padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .review-section { background: #0f172a; padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 0.8rem; max-height: 100px; overflow-y: auto; }
        .sidebar { flex: 1; min-width: 320px; background: #1e293b; padding: 20px; border-radius: 15px; border: 1px solid #334155; height: fit-content; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px; background: #0f172a; border-radius: 8px; margin-bottom: 5px; }
        .btn-add { background: var(--accent); color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; }
        .whatsapp-btn { background: #22c55e; color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; background: #0f172a; color: white; border: 1px solid #334155; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="color:var(--accent); margin:0;">NPX STORE</h1>
        <div id="cart-counter">ğŸ›’ 0</div>
    </div>
    <input type="text" id="searchInp" class="search-bar" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø© Ù…Ù„Ø§Ø¨Ø³..." onkeyup="search()">
</header>

<div class="container">
    <div class="products-grid" id="products-list"></div>

    <div class="sidebar">
        <h3>ğŸ›’ Ø§Ù„Ø³Ù„Ø©</h3>
        <div id="cart-list">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>
        <hr style="border:0.1px solid #334155;">
        <h2 style="text-align:center;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: $<span id="total-price">0.00</span></h2>
        
        <input type="text" id="uName" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input type="tel" id="uPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <textarea id="uAddress" rows="2" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></textarea>
        
        <button class="whatsapp-btn" onclick="checkout()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allItems = [];
    let cart = [];

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
    db.ref('inventory').on('value', snap => {
        const data = snap.val();
        allItems = [];
        for(let id in data) allItems.push({ id, ...data[id] });
        render();
    });

    function render() {
        const list = document.getElementById('products-list');
        list.innerHTML = allItems.map(p => `
            <div class="card">
                <div class="qty-badge">Ø§Ù„Ù…ØªÙˆÙØ±: ${p.qty}</div>
                <img src="${p.img}">
                <div style="padding:15px;">
                    <h3>${p.name}</h3>
                    <div style="color:var(--accent); font-weight:bold; margin-bottom:10px;">$${p.price}</div>
                    <button class="btn-add" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
                    
                    <div class="review-section" id="reviews-${p.id}">
                        <b>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:</b><br>
                        ${renderReviews(p.reviews)}
                    </div>
                    <input type="text" id="rev-inp-${p.id}" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ..." style="font-size:0.7rem;">
                    <button onclick="addReview('${p.id}')" style="font-size:0.7rem; width:100%; border:none; background:#334155; color:white; cursor:pointer;">Ù†Ø´Ø±</button>
                </div>
            </div>`).join('');
    }

    function renderReviews(revs) {
        if(!revs) return "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.";
        return Object.values(revs).map(r => `â€¢ ${r}`).join('<br>');
    }

    function addReview(id) {
        const txt = document.getElementById(`rev-inp-${id}`).value;
        if(txt) {
            db.ref(`inventory/${id}/reviews`).push(txt);
            document.getElementById(`rev-inp-${id}`).value = '';
        }
    }

    function addToCart(id) {
        const p = allItems.find(x => x.id === id);
        if(p.qty <= 0) return alert("Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©!");
        cart.push({...p});
        updateCart();
    }

    function updateCart() {
        const list = document.getElementById('cart-list');
        let sum = 0;
        document.getElementById('cart-counter').innerText = `ğŸ›’ ${cart.length}`;
        list.innerHTML = cart.map((i, idx) => {
            sum += parseFloat(i.price);
            return `<div class="cart-item"><span>${i.name}</span><button onclick="cart.splice(${idx},1);updateCart();" style="border:none;background:red;color:white;border-radius:50%;">Ã—</button></div>`;
        }).join('');
        document.getElementById('total-price').innerText = sum.toFixed(2);
    }

    function checkout() {
        const name = document.getElementById('uName').value;
        const phone = document.getElementById('uPhone').value;
        if(!name || cart.length === 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

        cart.forEach(item => {
            const newQty = item.qty - 1;
            if(newQty <= 0) {
                db.ref(`inventory/${item.id}`).remove(); // Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ØµÙØ±Øª Ø§Ù„ÙƒÙ…ÙŠØ©
            } else {
                db.ref(`inventory/${item.id}`).update({ qty: newQty }); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©
            }
        });

        const orderData = { user: name, phone: phone, items: cart.map(i => i.name), total: document.getElementById('total-price').innerText };
        db.ref('orders').push(orderData);
        alert("ØªÙ… Ø§Ù„Ø·Ù„Ø¨! Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.");
        window.location.reload();
    }
</script>
</body>
</html>
