<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Admin - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --red: #ef4444; --green: #10b981; --border: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-card h3 { margin: 5px 0; color: var(--p); font-size: 1.4rem; }
        .box { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        .admin-main { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: white; outline: none; }
        .btn-add { background: var(--p); border: none; font-weight: bold; cursor: pointer; }
        .order-card { background: #111827; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-right: 5px solid var(--p); }
        .order-actions { display: flex; gap: 8px; margin-top: 15px; }
        .btn-action { padding: 12px; border-radius: 8px; border: none; cursor: pointer; color: white; flex: 1; font-weight: bold; }
        .inv-item { display: flex; align-items: center; gap: 12px; background: #111827; padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .inv-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .qty-inp { width: 45px !important; padding: 5px !important; text-align: center; margin: 0 !important; border: 1px solid var(--p) !important; font-size: 0.8rem; }
        .hidden { display: none; }
        .tab-nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; background: var(--card); color: #94a3b8; font-weight: bold; }
        .tab-btn.active { background: var(--p); color: white; }
    </style>
</head>
<body>

    <div class="stats-grid">
        <div class="stat-card"><small>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small><h3 id="stMoney">0</h3></div>
        <div class="stat-card"><small>Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</small><h3 id="stOrders">0</h3></div>
        <div class="stat-card"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</small><h3 id="stStock">0</h3></div>
    </div>

    <div class="admin-main">
        <div class="box">
            <h3 style="margin-top:0">ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <select id="pCat">
                <option value="ØªÙŠØ´ÙŠØ±ØªØ§Øª">ØªÙŠØ´ÙŠØ±ØªØ§Øª</option>
                <option value="Ù‡ÙˆØ¯ÙŠØ²">Ù‡ÙˆØ¯ÙŠØ²</option>
                <option value="Ø¨Ù†Ø·Ù„ÙˆÙ†Ø§Øª">Ø¨Ù†Ø·Ù„ÙˆÙ†Ø§Øª</option>
                <option value="Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª">Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</option>
            </select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <input type="number" id="pS" placeholder="ÙƒÙ…ÙŠØ© S">
                <input type="number" id="pM" placeholder="ÙƒÙ…ÙŠØ© M">
                <input type="number" id="pL" placeholder="ÙƒÙ…ÙŠØ© L">
                <input type="number" id="pXL" placeholder="ÙƒÙ…ÙŠØ© XL">
            </div>
            <input type="file" id="pImage" accept="image/*" onchange="processImage(this.files[0])">
            <button class="btn-add" onclick="uploadToStore()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>

        <div class="box">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="toggleTab('ordersTab', this)">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                <button class="tab-btn" onclick="toggleTab('stockTab', this)">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²Ù†</button>
            </div>

            <div id="ordersTab">
                <input type="text" id="orderSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." onkeyup="renderOrders()">
                <div id="orderListArea"></div>
            </div>

            <div id="stockTab" class="hidden">
                <div id="stockListArea"></div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let imgBase64 = "";
    let localOrders = [];

    function processImage(file) {
        const reader = new FileReader();
        reader.onload = e => imgBase64 = e.target.result;
        reader.readAsDataURL(file);
    }

    function uploadToStore() {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        if(!name || !price || !imgBase64) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
        db.ref('inventory').push({
            name, price, category: document.getElementById('pCat').value,
            s: parseInt(document.getElementById('pS').value || 0),
            m: parseInt(document.getElementById('pM').value || 0),
            l: parseInt(document.getElementById('pL').value || 0),
            xl: parseInt(document.getElementById('pXL').value || 0),
            img: imgBase64
        }).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!"); location.reload(); });
    }

    function toggleTab(id, btn) {
        document.getElementById('ordersTab').classList.add('hidden');
        document.getElementById('stockTab').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    db.ref('orders').on('value', snap => {
        localOrders = [];
        let total = 0;
        snap.forEach(child => {
            localOrders.push({ id: child.key, ...child.val() });
            total += parseFloat(child.val().total);
        });
        document.getElementById('stMoney').innerText = total + " Ø¬.Ù…";
        document.getElementById('stOrders').innerText = localOrders.length;
        renderOrders();
    });

    function renderOrders() {
        const q = document.getElementById('orderSearch').value.toLowerCase();
        const area = document.getElementById('orderListArea');
        area.innerHTML = '';

        localOrders.filter(o => o.name.toLowerCase().includes(q) || o.phone.includes(q)).reverse().forEach(o => {
            area.innerHTML += `
                <div class="order-card">
                    <b>${o.name}</b> <small style="float:left; color:#94a3b8">${new Date(o.ts).toLocaleTimeString('ar-EG')}</small><br>
                    <small><i class="fas fa-phone"></i> ${o.phone}</small><br>
                    <small><i class="fas fa-map-marker-alt"></i> ${o.addr}</small>
                    <div style="margin:10px 0; padding:10px; background:#0f172a; border-radius:8px; font-size:0.85rem;">
                        ${o.items.map(i => `â€¢ ${i.name} (${i.sz.toUpperCase()}) Ã— ${i.qty}`).join('<br>')}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--green)">${o.total} Ø¬.Ù…</b>
                        <a href="${o.gps}" target="_blank" style="color:var(--p); text-decoration:none;"><i class="fas fa-location-arrow"></i> ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
                    </div>
                    <div class="order-actions">
                        <button class="btn-action" style="background:var(--green)" onclick="finishOrder('${o.id}')">ØªÙˆØµÙŠÙ„ âœ…</button>
                        <button class="btn-action" style="background:var(--red)" onclick="cancelAndRestore('${o.id}')">Ø¥Ù„ØºØ§Ø¡ âŒ</button>
                    </div>
                </div>`;
        });
    }

    // Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„
    function finishOrder(id) {
        if(confirm("Ù‡Ù„ ØªÙ… ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.")) {
            db.ref(`orders/${id}`).remove();
        }
    }

    // Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø®Ø²Ù†
    async function cancelAndRestore(id) {
        if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù„Ù„Ù…Ø®Ø²Ù† Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹.")) return;
        const snap = await db.ref(`orders/${id}`).get();
        if(snap.exists()) {
            const order = snap.val();
            for(let item of order.items) {
                const ref = db.ref(`inventory/${item.id}/${item.sz}`);
                const current = await ref.get();
                await ref.set((current.val() || 0) + item.qty);
            }
            db.ref(`orders/${id}`).remove();
        }
    }

    db.ref('inventory').on('value', snap => {
        const area = document.getElementById('stockListArea');
        let total = 0;
        area.innerHTML = '';
        snap.forEach(child => {
            const p = child.val();
            total += (p.s + p.m + p.l + p.xl);
            area.innerHTML += `
                <div class="inv-item">
                    <img src="${p.img}">
                    <div style="flex:1">
                        <b>${p.name}</b><br>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            S:<input class="qty-inp" type="number" value="${p.s}" onchange="editQty('${child.key}','s',this.value)">
                            M:<input class="qty-inp" type="number" value="${p.m}" onchange="editQty('${child.key}','m',this.value)">
                            L:<input class="qty-inp" type="number" value="${p.l}" onchange="editQty('${child.key}','l',this.value)">
                            XL:<input class="qty-inp" type="number" value="${p.xl}" onchange="editQty('${child.key}','xl',this.value)">
                        </div>
                    </div>
                    <i class="fas fa-trash" style="color:var(--red); cursor:pointer" onclick="deleteProduct('${child.key}')"></i>
                </div>`;
        });
        document.getElementById('stStock').innerText = total;
    });

    function editQty(id, size, val) { db.ref(`inventory/${id}`).update({ [size]: parseInt(val) }); }
    function deleteProduct(id) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) db.ref(`inventory/${id}`).remove(); }
</script>
</body>
</html>
