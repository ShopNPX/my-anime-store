<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Admin - المركز الرئيسي للإدارة</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #6366f1; --dark: #0f172a; --bg: #f8fafc; --white: #ffffff; --red: #ef4444; --green: #22c55e; --amber: #f59e0b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; direction: rtl; color: var(--dark); }
        
        /* Dashboard Header Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--white); padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-top: 5px solid var(--p); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2rem; color: var(--p); margin-bottom: 10px; }
        .stat-card h2 { margin: 10px 0; font-size: 2.2rem; }

        .layout { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; }
        @media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } }

        .box { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }

        /* Forms & Inputs */
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #e2e8f0; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--p); ring: 2px solid var(--p); }
        .size-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-main:hover { background: #4f46e5; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }

        /* Drag & Drop */
        #drop-zone { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 15px; cursor: pointer; background: #fdfdfd; color: #64748b; margin: 15px 0; }
        #drop-zone:hover { border-color: var(--p); background: #f8fafc; }
        #preview { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-top: 15px; border-radius: 10px; }

        /* Search Bar */
        .search-container { position: relative; margin-bottom: 20px; }
        .search-container i { position: absolute; left: 15px; top: 22px; color: #94a3b8; }
        .search-container input { padding-left: 45px; background: #fff; border-radius: 15px; height: 50px; }

        /* Order Cards */
        .order-card { background: var(--white); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-right: 8px solid var(--p); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .item-row { background: #f8fafc; padding: 10px 15px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; border: 1px solid #f1f5f9; }
        .badge { padding: 5px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; }
        .bg-pending { background: #fef3c7; color: #92400e; }
        .bg-done { background: #dcfce7; color: #166534; }
        
        .btn-action { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .btn-success { background: var(--green); color: white; flex: 2; justify-content: center; }
        .btn-del { background: #fff; color: var(--red); border: 1px solid var(--red); flex: 1; justify-content: center; }
        .btn-del:hover { background: var(--red); color: white; }
    </style>
</head>
<body>

    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-wallet"></i>
            <h3>إجمالي المبيعات</h3>
            <h2 id="stMoney">0 ج.م</h2>
        </div>
        <div class="stat-card">
            <i class="fas fa-shopping-cart"></i>
            <h3>إجمالي الطلبات</h3>
            <h2 id="stOrders">0</h2>
        </div>
        <div class="stat-card">
            <i class="fas fa-tshirt"></i>
            <h3>قطع مباعة</h3>
            <h2 id="stItems">0</h2>
        </div>
    </div>

    <div class="layout">
        <div class="box">
            <h3><i class="fas fa-plus-circle"></i> إضافة منتج جديد</h3>
            <input id="pName" type="text" placeholder="اسم المنتج">
            <input id="pPrice" type="number" placeholder="السعر (ج.م)">
            
            <select id="pCat">
                <option value="تيشيرتات">تيشيرتات</option>
                <option value="هوديز">هوديز</option>
                <option value="بنطلونات">بنطلونات</option>
                <option value="إكسسوارات">إكسسوارات</option>
            </select>

            <div class="size-grid">
                <input id="qs" type="number" placeholder="كمية S">
                <input id="qm" type="number" placeholder="كمية M">
                <input id="ql" type="number" placeholder="كمية L">
                <input id="qxl" type="number" placeholder="كمية XL">
            </div>

            <div id="drop-zone" onclick="document.getElementById('fileInp').click()">
                <i class="fas fa-cloud-upload-alt fa-2x"></i><br>
                <span>اسحب صورة المنتج هنا</span>
                <input type="file" id="fileInp" hidden onchange="handleFile(this.files[0])">
                <img id="preview">
            </div>
            
            <button class="btn-main" onclick="uploadProduct()">نشر في المتجر <i class="fas fa-rocket"></i></button>
        </div>

        <div class="box">
            <h3><i class="fas fa-list-ul"></i> إدارة الطلبات الحية</h3>
            
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="adminSearch" placeholder="ابحث باسم العميل، رقم الهاتف، أو المنتج..." onkeyup="syncOrders()">
            </div>

            <div id="ordersArea">
                <p style="text-align: center; color: #94a3b8;">جاري تحميل البيانات...</p>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let productB64 = "";
    let rawOrders = [];

    // Image Handling
    function handleFile(f) {
        if(!f) return;
        const reader = new FileReader();
        reader.onload = e => { 
            productB64 = e.target.result; 
            const img = document.getElementById('preview');
            img.src = productB64; img.style.display = "block";
            document.querySelector('#drop-zone span').style.display = "none";
        };
        reader.readAsDataURL(f);
    }

    // Add Product Logic
    function uploadProduct() {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        const cat = document.getElementById('pCat').value;
        const s = parseInt(document.getElementById('qs').value || 0);
        const m = parseInt(document.getElementById('qm').value || 0);
        const l = parseInt(document.getElementById('ql').value || 0);
        const xl = parseInt(document.getElementById('qxl').value || 0);

        if(!name || !price || !productB64) return alert("يرجى ملء كافة البيانات والصورة!");

        db.ref('inventory').push({
            name, price, category: cat, s, m, l, xl, img: productB64, timestamp: Date.now()
        }).then(() => {
            alert("تم إضافة المنتج بنجاح!");
            location.reload();
        });
    }

    // Load & Filter Orders
    db.ref('orders').on('value', snap => {
        rawOrders = [];
        snap.forEach(c => rawOrders.push({ id: c.key, ...c.val() }));
        syncOrders();
    });

    function syncOrders() {
        const query = document.getElementById('adminSearch').value.toLowerCase();
        const area = document.getElementById('ordersArea');
        let income = 0, count = 0, items = 0;
        
        area.innerHTML = '';

        const filtered = rawOrders.filter(o => 
            o.name.toLowerCase().includes(query) || 
            o.phone.includes(query) ||
            o.items.some(i => i.name.toLowerCase().includes(query))
        );

        rawOrders.forEach(o => { income += parseFloat(o.total); count++; o.items.forEach(i => items += i.qty); });

        filtered.forEach(o => {
            let itemsList = o.items.map(i => `
                <div class="item-row">
                    <span>${i.name} <b style="color:var(--p)">[${i.sz.toUpperCase()}]</b></span>
                    <span>${i.qty}x</span>
                </div>
            `).join('');

            area.innerHTML += `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <b style="font-size:1.2rem;">${o.name}</b><br>
                            <small style="color:#64748b;"><i class="fas fa-phone-alt"></i> ${o.phone}</small>
                        </div>
                        <span class="badge ${o.status === 'pending' ? 'bg-pending' : 'bg-done'}">
                            ${o.status === 'pending' ? 'قيد الانتظار' : 'تم التوصيل'}
                        </span>
                    </div>

                    <div style="margin:15px 0;">${itemsList}</div>
                    
                    <div style="font-size:0.9rem; color:#475569; margin-bottom:15px; background: #f1f5f9; padding:10px; border-radius:10px;">
                        <i class="fas fa-map-marker-alt"></i> العنوان: ${o.addr}
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <b style="font-size:1.4rem; color:var(--green);">${o.total} ج.م</b>
                        <a href="${o.gps}" target="_blank" style="color:var(--p); text-decoration:none; font-weight:bold;"><i class="fas fa-location-arrow"></i> فتح الموقع</a>
                    </div>

                    <div style="display:flex; gap:10px;">
                        ${o.status === 'pending' ? 
                            `<button class="btn-action btn-success" onclick="markDone('${o.id}')"><i class="fas fa-check"></i> تأكيد التوصيل (تقييم)</button>` : 
                            `<button class="btn-action btn-success" style="opacity:0.5; cursor:default" disabled>تم التسليم بنجاح</button>`
                        }
                        <button class="btn-action btn-del" onclick="deleteOrder('${o.id}')"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`;
        });

        document.getElementById('stMoney').innerText = income.toLocaleString() + " ج.م";
        document.getElementById('stOrders').innerText = count;
        document.getElementById('stItems').innerText = items;
    }

    function markDone(id) {
        if(confirm("هل تم تسليم الطلب؟ سيتم فتح التقييم للعميل فوراً.")) {
            db.ref('orders/' + id).update({ status: 'delivered' });
        }
    }

    function deleteOrder(id) {
        if(confirm("حذف الطلب نهائياً من السجلات؟")) {
            db.ref('orders/' + id).remove();
        }
    }
</script>
</body>
</html>
