<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Store - Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #6366f1; --dark: #0f172a; --card: #1e293b; --text: #f8fafc; --red: #ef4444; --green: #10b981; --gold: #fbbf24; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: var(--text); margin: 0; padding-bottom: 90px; overflow-x: hidden; }
        nav { background: #111827; padding: 12px 5%; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--p); }
        .srch-box { flex: 1; margin: 0 15px; }
        .srch-box input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; outline: none; }
        #status-bar { display: none; background: var(--card); border-bottom: 3px solid var(--p); padding: 15px; text-align: center; position: sticky; top: 62px; z-index: 999; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; padding: 20px 5%; }
        .card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #334155; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--p); }
        .card img { width: 100%; height: 250px; object-fit: cover; }
        .p-info { padding: 15px; }
        .sizes { display: flex; gap: 5px; margin: 12px 0; }
        .sz-btn { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .sz-btn.active { background: var(--p); border-color: var(--p); box-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }
        .sz-btn:disabled { opacity: 0.2; cursor: not-allowed; border-color: #ff4444; }
        .add-btn { width: 100%; padding: 14px; background: var(--p); border: none; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .add-btn:active { transform: scale(0.95); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; box-sizing: border-box; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

<nav>
    <div style="font-weight: 900; color: var(--p); font-size: 1.4rem; letter-spacing: 1px;">NPX STORE</div>
    <div class="srch-box"><input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="renderItems()"></div>
    <div onclick="openCart()" style="cursor:pointer; position:relative;">
        <i class="fas fa-shopping-bag fa-lg"></i>
        <span id="cartCount" style="position:absolute; top:-8px; right:-8px; background:var(--red); color:white; padding:2px 6px; border-radius:50%; font-size:0.7rem; font-weight:bold;">0</span>
    </div>
</nav>

<div id="status-bar">
    <b id="statusTitle" style="color:var(--green)">ğŸ“¦ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</b><br>
    <small id="statusTimer"></small><br>
    <button id="cancelOrderBtn" onclick="handleCancel()" style="display:none; background:var(--red); color:white; border:none; padding:8px 15px; border-radius:8px; margin-top:10px; cursor:pointer; font-weight:bold;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø®Ø²Ù†</button>
</div>

<div class="grid" id="mainGrid"></div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0; color:var(--p)"><i class="fas fa-shopping-cart"></i> Ø³Ù„ØªÙƒ</h2>
        <div id="itemsInCart"></div>
        <div style="text-align:center; font-size:1.2rem; font-weight:bold; margin:20px 0; color:var(--green);">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ: <span id="totalPrice">0</span> Ø¬.Ù…</div>
        
        <input id="custName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input id="custPhone" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
        <button onclick="getLocation()" style="width:100%; padding:12px; background:#3b82f6; color:white; border:none; border-radius:10px; margin-bottom:8px; font-weight:bold;"><i class="fas fa-map-marker-alt"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„ GPS</button>
        <textarea id="custAddr" rows="3" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø²Ù„)"></textarea>
        
        <button onclick="sendOrder()" style="width:100%; padding:16px; background:var(--green); color:white; border:none; border-radius:15px; font-weight:bold; font-size:1.1rem;"><i class="fab fa-whatsapp"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button onclick="closeCart()" style="display:block; margin:15px auto; color:#94a3b8; background:none; border:none; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù„Ø©</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let products = [], cart = [], gpsData = "Ù„Ù… ÙŠØ­Ø¯Ø¯";

    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ø­Ø¸ÙŠØ§Ù‹
    db.ref('inventory').on('value', snap => {
        products = [];
        snap.forEach(c => products.push({id: c.key, ...c.val()}));
        renderItems();
    });

    function renderItems() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const activeID = localStorage.getItem('order_id');
        
        document.getElementById('mainGrid').innerHTML = products.filter(p => p.name.toLowerCase().includes(q)).map(p => `
            <div class="card">
                <img src="${p.img}" loading="lazy">
                <div class="p-info">
                    <h3 style="margin:0 0 10px 0">${p.name}</h3>
                    <div class="sizes" id="sz-${p.id}">
                        <button class="sz-btn" ${p.s<=0?'disabled':''} onclick="selectSize(this,'s')">S</button>
                        <button class="sz-btn" ${p.m<=0?'disabled':''} onclick="selectSize(this,'m')">M</button>
                        <button class="sz-btn" ${p.l<=0?'disabled':''} onclick="selectSize(this,'l')">L</button>
                        <button class="sz-btn" ${p.xl<=0?'disabled':''} onclick="selectSize(this,'xl')">XL</button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                        <b style="color:var(--green); font-size:1.3rem;">${p.price} Ø¬.Ù…</b>
                        <button class="add-btn" style="width:auto; padding:10px 20px" ${activeID?'disabled':''} onclick="addToCart('${p.id}')">
                            ${activeID ? 'Ø§Ù†ØªØ¸Ø± Ø·Ù„Ø¨Ùƒ' : 'Ø¥Ø¶Ø§ÙØ© +'}
                        </button>
                    </div>
                </div>
            </div>`).join('');
    }

    function selectSize(btn, s) { 
        btn.parentElement.querySelectorAll('.sz-btn').forEach(b=>b.classList.remove('active')); 
        btn.classList.add('active'); 
        btn.dataset.sz = s; 
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        const btn = document.querySelector(`#sz-${id} .active`);
        if(!btn) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³ Ø£ÙˆÙ„Ø§Ù‹");
        
        const sz = btn.dataset.sz;
        const stockAvailable = parseInt(p[sz]); // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†
        const inCart = cart.find(i => i.id === id && i.sz === sz);
        const currentQtyInCart = inCart ? inCart.qty : 0;

        // ÙØ­Øµ Ø§Ù„Ù…Ø®Ø²Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        if (currentQtyInCart + 1 > stockAvailable) {
            alert(`Ù†Ø¹ØªØ°Ø±! Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙˆÙ‰ ${stockAvailable} Ù‚Ø·Ø¹ ÙÙ‚Ø· Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ø³.`);
            return;
        }

        if(inCart) {
            inCart.qty++;
        } else {
            cart.push({ id, name: p.name, price: p.price, sz, qty: 1 });
        }
        updateCartUI();
    }

    function updateCartUI() {
        let t = 0, c = 0;
        document.getElementById('itemsInCart').innerHTML = cart.map((i,idx) => {
            t += (i.price*i.qty); c += i.qty;
            return `<div class="cart-item">
                <div>
                    <b>${i.name}</b> <small>(${i.sz.toUpperCase()})</small><br>
                    <span style="color:var(--p)">${i.qty} Ù‚Ø·Ø¹Ø© Ã— ${i.price} Ø¬.Ù…</span>
                </div>
                <i class="fas fa-trash-alt" style="color:var(--red); cursor:pointer" onclick="cart.splice(${idx},1);updateCartUI()"></i>
            </div>`;
        }).join('');
        document.getElementById('cartCount').innerText = c;
        document.getElementById('totalPrice').innerText = t;
    }

    function openCart() { document.getElementById('cartModal').style.display='flex'; }
    function closeCart() { document.getElementById('cartModal').style.display='none'; }
    
    function getLocation() { 
        navigator.geolocation.getCurrentPosition(p => { 
            gpsData = `https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`; 
            document.getElementById('custAddr').value = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­"; 
        }, () => alert("Ø¨Ø±Ø¬Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ")); 
    }

    async function sendOrder() {
        const n = document.getElementById('custName').value, ph = document.getElementById('custPhone').value, ad = document.getElementById('custAddr').value;
        if(!n || !ph || !ad || cart.length === 0) return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙˆØ±Ù‡Ø±ÙŠØ©");

        let total = document.getElementById('totalPrice').innerText;
        let itemsMsg = cart.map(i => `â€¢ *${i.name}* (Ù…Ù‚Ø§Ø³ ${i.sz.toUpperCase()}) Ã— ${i.qty}`).join('%0A');
        
        // Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
        let finalMsg = `*Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ - NPX STORE*%0A` +
                       `------------------------------%0A` +
                       `*Ø§Ù„Ø¹Ù…ÙŠÙ„:* ${n}%0A` +
                       `*Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:* ${ph}%0A` +
                       `*Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:* ${ad}%0A` +
                       `------------------------------%0A` +
                       `*Ø§Ù„Ø·Ù„Ø¨Ø§Øª:*%0A${itemsMsg}%0A` +
                       `------------------------------%0A` +
                       `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:* ${total} Ø¬.Ù…%0A` +
                       `*Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹:* ${gpsData}`;

        // Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        for(let i of cart) { 
            const ref = db.ref(`inventory/${i.id}/${i.sz}`); 
            const snap = await ref.get(); 
            await ref.set(snap.val() - i.qty); 
        }

        // Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
        const oRef = db.ref('orders').push({ 
            name:n, phone:ph, items:cart, total:total, ts:Date.now(), gps:gpsData, addr:ad 
        });
        
        localStorage.setItem('order_id', oRef.key);
        localStorage.setItem('order_items', JSON.stringify(cart));
        
        window.location.href = `https://wa.me/201221060599?text=${finalMsg}`;
    }

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ
    const activeOID = localStorage.getItem('order_id');
    if(activeOID) {
        db.ref('orders/' + activeOID).on('value', snap => {
            const bar = document.getElementById('status-bar');
            if(!snap.exists()) {
                if(localStorage.getItem('order_id')) {
                    localStorage.clear();
                    alert("ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø·Ù„Ø¨Ùƒ! Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„Ùƒ Ù…Ø¹Ù†Ø§.");
                    location.reload();
                }
                return;
            }
            bar.style.display = 'block';
            const o = snap.val();
            const diff = (Date.now() - o.ts) / 1000 / 60;
            if(diff < 60) {
                document.getElementById('cancelOrderBtn').style.display = "inline-block";
                document.getElementById('statusTimer').innerText = `ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø®Ù„Ø§Ù„ ${Math.floor(60-diff)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            } else {
                document.getElementById('cancelOrderBtn').style.display = "none";
                document.getElementById('statusTimer').innerText = "ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†";
            }
        });
    }

    async function handleCancel() {
        if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…Ø®Ø²Ù† ÙÙˆØ±Ø§Ù‹.")) return;
        const id = localStorage.getItem('order_id'), items = JSON.parse(localStorage.getItem('order_items'));
        for(let i of items) { 
            const ref = db.ref(`inventory/${i.id}/${i.sz}`); 
            const snap = await ref.get(); 
            await ref.set(snap.val() + i.qty); 
        }
        db.ref('orders/'+id).remove();
        localStorage.clear(); 
        location.reload();
    }
</script>
</body>
</html>
