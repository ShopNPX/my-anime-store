<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX STORE | النسخة الكاملة</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --bg: #030712;
            --card: #111827;
            --text: #ffffff;
            --border: rgba(255,255,255,0.1);
        }

        [data-theme="light"] {
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #111827;
            --border: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; transition: 0.2s ease; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding-top: 195px; overflow-x: hidden; }

        /* Header Fix */
        header { position: fixed; top: 0; width: 100%; background: var(--bg); z-index: 1000; border-bottom: 1px solid var(--border); }
        .nav-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; }
        .nav-icons { display: flex; gap: 10px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 12px; background: var(--card); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); position: relative; color: var(--text); text-decoration: none; }
        #cartCount { position: absolute; top: -5px; right: -5px; background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; }

        /* Search & Cats */
        .search-area { padding: 0 5% 10px; }
        .search-bar { background: var(--card); border-radius: 12px; display: flex; align-items: center; padding: 5px 15px; border: 1px solid var(--border); }
        .search-bar input { background: transparent; border: none; color: var(--text); padding: 10px; width: 100%; outline: none; }
        .categories { display: flex; gap: 10px; padding: 10px 5%; overflow-x: auto; background: var(--bg); border-top: 1px solid var(--border); }
        .categories::-webkit-scrollbar { display: none; }
        .cat-btn { padding: 8px 18px; border-radius: 50px; border: 1px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; white-space: nowrap; font-size: 0.8rem; }
        .cat-btn.active { background: var(--primary); color: white; }

        /* Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; padding: 20px 5%; }
        .product-card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); }
        .product-card img { width: 100%; height: 280px; object-fit: cover; }
        
        /* Sidebars */
        .sidebar { position: fixed; top: 0; left: -100%; width: 100%; max-width: 450px; height: 100%; background: var(--card); z-index: 2001; display: flex; flex-direction: column; box-shadow: 20px 0 50px rgba(0,0,0,0.5); visibility: hidden; }
        .sidebar.open { left: 0; visibility: visible; }
        .sb-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        
        /* Buttons */
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .qty-btn { width: 28px; height: 28px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* Admin Styles */
        .admin-order-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
        .status-select { padding: 5px; border-radius: 5px; background: #000; color: #fff; border: 1px solid var(--primary); }

        @media (max-width: 500px) { .sidebar { max-width: 100%; } .product-grid { grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; } body { padding-top: 185px; } }
    </style>
</head>
<body data-theme="dark">

    <header>
        <div class="nav-top">
            <div style="font-weight: 900; font-size: 1.5rem;">NPX STORE</div>
            <div class="nav-icons">
                <div class="icon-btn" onclick="toggleSidebar('adminPanel', true)"><i class="fas fa-lock"></i></div>
                <div class="icon-btn" onclick="toggleSidebar('settingsSidebar', true)"><i class="fas fa-user-cog"></i></div>
                <div class="icon-btn" onclick="toggleSidebar('cartSidebar', true)">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cartCount">0</span>
                </div>
            </div>
        </div>
        <div class="search-area">
            <div class="search-bar">
                <i class="fas fa-search" style="opacity: 0.5;"></i>
                <input type="text" id="searchInput" placeholder="ابحث عن الموديل..." onkeyup="render()">
            </div>
        </div>
        <div class="categories" id="catBar">
            <button class="cat-btn active" onclick="filterBy('الكل', this)">الكل</button>
            <button class="cat-btn" onclick="filterBy('تيشيرتات', this)">تيشيرتات</button>
            <button class="cat-btn" onclick="filterBy('هوديز', this)">هوديز</button>
            <button class="cat-btn" onclick="filterBy('بنطلونات', this)">بنطلونات</button>
        </div>
    </header>

    <div class="product-grid" id="productGrid"></div>

    <div class="sidebar" id="settingsSidebar">
        <div class="sb-header">
            <h3>المتابعة والإعدادات</h3>
            <div class="icon-btn" onclick="toggleSidebar('settingsSidebar', false)"><i class="fas fa-times"></i></div>
        </div>
        <div style="padding: 20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span>الوضع الليلي</span>
                <button class="icon-btn" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
            <h4>تتبع حالة طلبك</h4>
            <div style="display:flex; gap:5px;">
                <input type="tel" id="trackPhone" placeholder="رقم الموبايل..." style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                <button class="icon-btn" style="background:var(--primary); color:white;" onclick="trackOrder()"><i class="fas fa-search"></i></button>
            </div>
            <div id="trackerResults" style="margin-top:15px;"></div>
        </div>
    </div>

    <div class="sidebar" id="cartSidebar">
        <div class="sb-header">
            <h3>سلة التسوق</h3>
            <div class="icon-btn" onclick="toggleSidebar('cartSidebar', false)"><i class="fas fa-times"></i></div>
        </div>
        <div id="cartList" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding:20px; background: rgba(0,0,0,0.03);">
            <h3 id="totalLabel">الإجمالي: 0 ج.م</h3>
            <button class="btn-main" onclick="toggleSidebar('orderModal', true)">إتمام الطلب</button>
        </div>
    </div>

    <div class="sidebar" id="adminPanel">
        <div class="sb-header">
            <h3>لوحة التحكم (Admin)</h3>
            <div class="icon-btn" onclick="toggleSidebar('adminPanel', false)"><i class="fas fa-times"></i></div>
        </div>
        <div style="padding: 20px; flex:1; overflow-y:auto;">
            <div id="adminLogin">
                <input type="password" id="adminPass" placeholder="كلمة المرور" class="btn-main" style="background:var(--bg); border:1px solid var(--border); margin-bottom:10px;">
                <button class="btn-main" onclick="checkAdmin()">دخول المسؤول</button>
            </div>
            <div id="adminContent" style="display:none;">
                <h4>الطلبات الحالية</h4>
                <div id="adminOrdersList"></div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="orderModal">
        <div class="sb-header">
            <h3>بيانات الشحن</h3>
            <div class="icon-btn" onclick="toggleSidebar('orderModal', false)"><i class="fas fa-times"></i></div>
        </div>
        <div style="padding: 20px;">
            <button id="gpsBtn" class="btn-main" style="background:none; border:1px solid var(--primary); color:var(--text); margin-bottom:15px;" onclick="manualLocate()">
                <i class="fas fa-location-arrow"></i> <span id="gpsText">إرسال موقع منزلي GPS</span>
            </button>
            <input type="text" id="uName" placeholder="الاسم الكامل" class="btn-main" style="background:var(--bg); text-align:right; margin-bottom:10px; border:1px solid var(--border);">
            <input type="tel" id="uPhone" placeholder="رقم الواتساب" class="btn-main" style="background:var(--bg); text-align:right; margin-bottom:10px; border:1px solid var(--border);">
            <input type="text" id="uAddr" placeholder="العنوان بالتفصيل" class="btn-main" style="background:var(--bg); text-align:right; margin-bottom:20px; border:1px solid var(--border);">
            <button class="btn-main" onclick="processFinalOrder()">تأكيد وإرسال عبر واتساب</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allProducts = [], cart = [], currentCat = "الكل", userLocation = null;

        // Fetch Products
        db.ref('inventory').on('value', snap => {
            allProducts = [];
            snap.forEach(c => allProducts.push({id: c.key, ...c.val()}));
            render();
        });

        function render() {
            const grid = document.getElementById('productGrid');
            const query = document.getElementById('searchInput').value.toLowerCase();
            grid.innerHTML = '';
            
            allProducts.filter(p => (currentCat === "الكل" || p.category === currentCat) && p.name.toLowerCase().includes(query))
            .forEach(p => {
                grid.innerHTML += `
                <div class="product-card">
                    <img src="${p.img}">
                    <div style="padding:15px; text-align:center;">
                        <h4 style="margin:5px 0;">${p.name}</h4>
                        <div style="color:var(--primary); font-weight:bold;">${p.price} ج.م</div>
                        <select id="sz-${p.id}" style="width:100%; margin:10px 0; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                            ${p.s > 0 ? `<option value="s">S</option>` : ''}
                            ${p.m > 0 ? `<option value="m">M</option>` : ''}
                            ${p.l > 0 ? `<option value="l">L</option>` : ''}
                            ${p.xl > 0 ? `<option value="xl">XL</option>` : ''}
                        </select>
                        <button class="btn-main" style="padding:10px;" onclick="addToCart('${p.id}')">إضافة للسلة</button>
                    </div>
                </div>`;
            });
        }

        function toggleTheme() {
            const b = document.body;
            b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }

        function toggleSidebar(id, show) { document.getElementById(id).classList.toggle('open', show); }

        function addToCart(id) {
            const p = allProducts.find(x => x.id === id);
            const size = document.getElementById(`sz-${id}`).value;
            if(!size) return alert("نفذت الكمية");
            const item = cart.find(i => i.id === id && i.selectedSize === size);
            item ? item.qty++ : cart.push({...p, selectedSize: size, qty: 1});
            updateUI();
            toggleSidebar('cartSidebar', true);
        }

        function updateUI() {
            const list = document.getElementById('cartList');
            let tot = 0; list.innerHTML = '';
            cart.forEach((item, idx) => {
                tot += (item.price * item.qty);
                list.innerHTML += `
                <div style="display:flex; gap:15px; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                    <img src="${item.img}" style="width:60px; height:60px; border-radius:10px; object-fit:cover;">
                    <div style="flex:1">
                        <div style="font-weight:bold; font-size:0.8rem;">${item.name} (${item.selectedSize.toUpperCase()})</div>
                        <div style="color:var(--primary); font-size:0.8rem;">${item.price} ج.م</div>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                            <button class="qty-btn" onclick="changeQty(${idx}, -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
                        </div>
                    </div>
                    <i class="fas fa-trash-alt" style="color:red; cursor:pointer;" onclick="cart.splice(${idx},1); updateUI();"></i>
                </div>`;
            });
            document.getElementById('cartCount').innerText = cart.length;
            document.getElementById('totalLabel').innerText = `الإجمالي: ${tot} ج.م`;
        }

        function changeQty(idx, val) {
            cart[idx].qty += val;
            if(cart[idx].qty < 1) cart.splice(idx, 1);
            updateUI();
        }

        function filterBy(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentCat = cat; render();
        }

        function manualLocate() {
            navigator.geolocation.getCurrentPosition(pos => {
                userLocation = `${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('gpsText').innerText = "تم تحديد الموقع ✓";
            });
        }

        // --- Admin Logic ---
        function checkAdmin() {
            if(document.getElementById('adminPass').value === "123") { // كلمة المرور
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadAdminOrders();
            } else { alert("كلمة مرور خاطئة"); }
        }

        function loadAdminOrders() {
            db.ref('orders').on('value', snap => {
                const list = document.getElementById('adminOrdersList');
                list.innerHTML = '';
                snap.forEach(c => {
                    const order = c.val();
                    list.innerHTML += `
                    <div class="admin-order-card">
                        <b>${order.name}</b> (${order.phone})<br>
                        <small>${order.date}</small><br>
                        <select class="status-select" onchange="updateStatus('${c.key}', this.value)">
                            <option value="قيد المراجعة" ${order.status === 'قيد المراجعة' ? 'selected' : ''}>قيد المراجعة</option>
                            <option value="تم الشحن" ${order.status === 'تم الشحن' ? 'selected' : ''}>تم الشحن</option>
                            <option value="تم التوصيل" ${order.status === 'تم التوصيل' ? 'selected' : ''}>تم التوصيل</option>
                        </select>
                        <button onclick="window.open('${order.gps}')" style="background:none; border:none; color:var(--primary); cursor:pointer">الموقع</button>
                        <button onclick="db.ref('orders/${c.key}').remove()" style="color:red; background:none; border:none; cursor:pointer">حذف</button>
                    </div>`;
                });
            });
        }

        function updateStatus(key, val) { db.ref(`orders/${key}/status`).set(val); }

        // --- Tracker ---
        function trackOrder() {
            const phone = document.getElementById('trackPhone').value;
            const container = document.getElementById('trackerResults');
            if(!phone) return;
            db.ref('orders').orderByChild('phone').equalTo(phone).once('value', snap => {
                container.innerHTML = '';
                if(!snap.exists()) container.innerHTML = "لا يوجد طلبات";
                snap.forEach(c => {
                    const o = c.val();
                    container.innerHTML += `<div style="padding:10px; background:rgba(255,255,255,0.05); border-radius:10px; margin-bottom:5px;">
                        حالة الطلب: <b style="color:var(--primary)">${o.status || 'قيد المراجعة'}</b><br><small>${o.date}</small>
                    </div>`;
                });
            });
        }

        async function processFinalOrder() {
            const name = document.getElementById('uName').value, phone = document.getElementById('uPhone').value, addr = document.getElementById('uAddr').value;
            if(!name || !phone || !addr) return alert("اكمل البيانات");

            const maps = userLocation ? `https://www.google.com/maps?q=${userLocation}` : `https://www.google.com/maps/search/${encodeURIComponent(addr)}`;
            const orderData = { name, phone, addr, items: cart, total: document.getElementById('totalLabel').innerText, gps: maps, date: new Date().toLocaleString('ar-EG'), status: 'قيد المراجعة' };

            await db.ref('orders').push(orderData);
            for(let i of cart) {
                const r = db.ref(`inventory/${i.id}/${i.selectedSize}`);
                const s = await r.get();
                await r.set(s.val() - i.qty);
            }

            const wpMsg = `*طلب جديد NPX STORE*%0A*الاسم:* ${name}%0A*الطلبات:*%0A${cart.map(i => `• ${i.name} (${i.selectedSize.toUpperCase()}) x${i.qty}`).join('%0A')}%0A*الحساب:* ${orderData.total}%0A*الموقع:* ${maps}`;
            window.open(`https://wa.me/2010XXXXXXXX?text=${wpMsg}`, '_blank'); // استبدل X برقمك
            location.reload();
        }
    </script>
</body>
</html>
