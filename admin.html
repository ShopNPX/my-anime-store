<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPX Admin - لوحة التحكم الاحترافية</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --red: #ef4444; --green: #10b981; --border: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; box-sizing: border-box; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-card h3 { margin: 5px 0; color: var(--p); font-size: 1.4rem; }
        .stat-card small { color: #94a3b8; font-weight: bold; }
        .admin-main { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .box { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid var(--border); height: fit-content; }
        input, select, textarea, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--border); background: #0f172a; color: white; outline: none; box-sizing: border-box; }
        .btn-add { background: var(--p); border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-nav { display: flex; gap: 8px; margin-bottom: 20px; background: #111827; padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: #94a3b8; font-weight: bold; }
        .tab-btn.active { background: var(--p); color: white; }
        .inv-item { display: flex; align-items: center; gap: 12px; background: #111827; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
        .inv-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .qty-controls { display: flex; gap: 5px; }
        .qty-inp { width: 45px !important; padding: 4px !important; text-align: center; margin: 0 !important; font-size: 0.75rem; border: 1px solid var(--p) !important; }
        .order-card { background: #111827; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-right: 5px solid var(--p); position: relative; }
        .order-actions { display: flex; gap: 8px; margin-top: 12px; }
        .btn-action { padding: 10px; border-radius: 8px; border: none; cursor: pointer; color: white; font-size: 0.85rem; flex: 1; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="stats-grid">
        <div class="stat-card"><small>إجمالي المبيعات</small><h3 id="stMoney">0</h3></div>
        <div class="stat-card"><small>الطلبات الحالية</small><h3 id="stOrders">0</h3></div>
        <div class="stat-card"><small>قطع المخزن</small><h3 id="stStock">0</h3></div>
    </div>

    <div class="admin-main">
        <div class="box">
            <h3><i class="fas fa-plus-circle"></i> إضافة منتج</h3>
            <input type="text" id="pName" placeholder="اسم المنتج">
            <input type="number" id="pPrice" placeholder="السعر">
            <select id="pCat">
                <option value="تيشيرتات">تيشيرتات</option>
                <option value="هوديز">هوديز</option>
                <option value="بنطلونات">بنطلونات</option>
                <option value="إكسسوارات">إكسسوارات</option>
            </select>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <input type="number" id="pS" placeholder="كمية S">
                <input type="number" id="pM" placeholder="كمية M">
                <input type="number" id="pL" placeholder="كمية L">
                <input type="number" id="pXL" placeholder="كمية XL">
            </div>
            <input type="file" id="pImage" accept="image/*" onchange="processImage(this.files[0])">
            <button class="btn-add" onclick="uploadToStore()">نشر في المتجر</button>
        </div>

        <div class="box">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="toggleTab('ordersTab', this)">طلبات نشطة</button>
                <button class="tab-btn" onclick="toggleTab('stockTab', this)">المخزن</button>
            </div>

            <div id="ordersTab">
                <input type="text" id="orderSearch" placeholder="بحث..." onkeyup="renderOrders()">
                <div id="orderListArea"></div>
            </div>

            <div id="stockTab" class="hidden">
                <div id="stockListArea"></div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://authen-36a1f-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let imgBase64 = "";
    let localOrders = [];

    function processImage(file) {
        const reader = new FileReader();
        reader.onload = e => imgBase64 = e.target.result;
        reader.readAsDataURL(file);
    }

    function uploadToStore() {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        if(!name || !price || !imgBase64) return alert("أكمل البيانات!");
        db.ref('inventory').push({
            name, price, category: document.getElementById('pCat').value,
            s: parseInt(document.getElementById('pS').value || 0),
            m: parseInt(document.getElementById('pM').value || 0),
            l: parseInt(document.getElementById('pL').value || 0),
            xl: parseInt(document.getElementById('pXL').value || 0),
            img: imgBase64
        }).then(() => { alert("تم النشر!"); location.reload(); });
    }

    function toggleTab(id, btn) {
        document.getElementById('ordersTab').classList.add('hidden');
        document.getElementById('stockTab').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    db.ref('orders').on('value', snap => {
        localOrders = [];
        let totalCash = 0;
        snap.forEach(child => {
            localOrders.push({ id: child.key, ...child.val() });
            totalCash += parseFloat(child.val().total);
        });
        document.getElementById('stMoney').innerText = totalCash + " ج.م";
        document.getElementById('stOrders').innerText = localOrders.length;
        renderOrders();
    });

    function renderOrders() {
        const q = document.getElementById('orderSearch').value.toLowerCase();
        const area = document.getElementById('orderListArea');
        area.innerHTML = '';

        localOrders.filter(o => o.name.toLowerCase().includes(q)).reverse().forEach(o => {
            area.innerHTML += `
                <div class="order-card">
                    <b>${o.name}</b> <br>
                    <small><i class="fas fa-phone"></i> ${o.phone}</small><br>
                    <small><i class="fas fa-map-marker-alt"></i> ${o.addr}</small>
                    <div style="margin:8px 0; padding:8px; background:#0f172a; border-radius:8px; font-size:0.85rem;">
                        ${o.items.map(i => `• ${i.name} (${i.sz}) x${i.qty}`).join('<br>')}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--green)">${o.total} ج.م</b>
                        <a href="${o.gps}" target="_blank" style="color:var(--p); text-decoration:none;"><i class="fas fa-location-arrow"></i> GPS</a>
                    </div>
                    <div class="order-actions">
                        <button class="btn-action" style="background:var(--green)" onclick="deleteOrder('${o.id}', true)">تم التوصيل ✅</button>
                        <button class="btn-action" style="background:var(--red)" onclick="declineAndRestore('${o.id}')">إلغاء وإرجاع للمخزن ❌</button>
                    </div>
                </div>`;
        });
    }

    function deleteOrder(id, confirmMsg) {
        if(confirmMsg && !confirm("هل تريد إزالة هذا الطلب من القائمة؟")) return;
        db.ref(`orders/${id}`).remove();
    }

    async function declineAndRestore(id) {
        if(!confirm("هل تريد إلغاء الطلب وإعادة المنتجات للمخزن؟")) return;
        const snap = await db.ref(`orders/${id}`).get();
        if(snap.exists()) {
            const order = snap.val();
            for(let item of order.items) {
                const ref = db.ref(`inventory/${item.id}/${item.sz}`);
                const currentStock = await ref.get();
                await ref.set((currentStock.val() || 0) + item.qty);
            }
            db.ref(`orders/${id}`).remove();
            alert("تم الإلغاء وإعادة المخزن بنجاح");
        }
    }

    db.ref('inventory').on('value', snap => {
        const area = document.getElementById('stockListArea');
        let total = 0;
        area.innerHTML = '';
        snap.forEach(child => {
            const p = child.val();
            total += (p.s + p.m + p.l + p.xl);
            area.innerHTML += `
                <div class="inv-item">
                    <img src="${p.img}">
                    <div class="inv-info">
                        <b>${p.name}</b>
                        <div class="qty-controls">
                            S:<input class="qty-inp" type="number" value="${p.s}" onchange="editQty('${child.key}','s',this.value)">
                            M:<input class="qty-inp" type="number" value="${p.m}" onchange="editQty('${child.key}','m',this.value)">
                            L:<input class="qty-inp" type="number" value="${p.l}" onchange="editQty('${child.key}','l',this.value)">
                            XL:<input class="qty-inp" type="number" value="${p.xl}" onchange="editQty('${child.key}','xl',this.value)">
                        </div>
                    </div>
                    <i class="fas fa-trash-alt" style="color:var(--red); cursor:pointer" onclick="deleteProduct('${child.key}')"></i>
                </div>`;
        });
        document.getElementById('stStock').innerText = total;
    });

    function editQty(id, size, val) { db.ref(`inventory/${id}`).update({ [size]: parseInt(val) }); }
    function deleteProduct(id) { if(confirm("حذف المنتج نهائياً؟")) db.ref(`inventory/${id}`).remove(); }
</script>
</body>
</html>
